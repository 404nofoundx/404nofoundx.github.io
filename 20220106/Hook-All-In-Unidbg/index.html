<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><meta name="baidu-site-verification" content="code-Um7dmQVTiB"><title>Hook All In Unidbg - ZRocket</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="ZRocket"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="ZRocket"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="本文总结了Unidbg Hook and Call 的知识，部分Hook代码采用Frida 与 Unidbg 对照的方式，帮助熟悉Frida但不熟悉Unidbg的读者快速入门。"><meta property="og:type" content="blog"><meta property="og:title" content="ZRocket"><meta property="og:url" content="http://www.404nofoundx.top/20220106/Hook-All-In-Unidbg/"><meta property="og:site_name" content="ZRocket"><meta property="og:description" content="本文总结了Unidbg Hook and Call 的知识，部分Hook代码采用Frida 与 Unidbg 对照的方式，帮助熟悉Frida但不熟悉Unidbg的读者快速入门。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://gitee.com/nofound404/image-cloud/raw/master/桃子unidbg.png"><meta property="article:published_time" content="2022-01-06T02:19:27.000Z"><meta property="article:modified_time" content="2022-01-13T12:02:28.248Z"><meta property="article:author" content="ZRocket"><meta property="article:tag" content="Unidbg"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://gitee.com/nofound404/image-cloud/raw/master/桃子unidbg.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.404nofoundx.top/20220106/Hook-All-In-Unidbg/"},"headline":"Hook All In Unidbg","image":["https://gitee.com/nofound404/image-cloud/raw/master/桃子unidbg.png"],"datePublished":"2022-01-06T02:19:27.000Z","dateModified":"2022-01-13T12:02:28.248Z","author":{"@type":"Person","name":"Zhan"},"publisher":{"@type":"Organization","name":"ZRocket","logo":{"@type":"ImageObject","url":{"text":"ZRocket"}}},"description":"本文总结了Unidbg Hook and Call 的知识，部分Hook代码采用Frida 与 Unidbg 对照的方式，帮助熟悉Frida但不熟悉Unidbg的读者快速入门。"}</script><link rel="canonical" href="http://www.404nofoundx.top/20220106/Hook-All-In-Unidbg/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?52c041fd9882a2d4b05bb16f933cdf75";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">ZRocket</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/404nofoundx"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><h1 class="title is-3 is-size-4-mobile">Hook All In Unidbg</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="far fa-calendar-alt"> </i><time dateTime="${date_xml(page.date)}" title="${date_xml(page.date)}">2022-01-06</time></span><span class="level-item is-hidden-mobile"><i class="far fa-calendar-check"> </i><time dateTime="${date_xml(page.updated)}" title="${date_xml(page.updated)}">2022-01-13</time></span><span class="level-item"><a class="link-muted" href="/categories/Unidbg/">Unidbg</a></span><span class="level-item">1 小时读完 (大约12998个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><div class="content"><blockquote>
<p>原文链接: <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38851536/category_11102404.html">https://blog.csdn.net/qq_38851536/category_11102404.html</a></p>
<p>更多Unidbg使用和算法还原的教程可见龙哥星球。</p>
<p>本文总结了Unidbg Hook and Call 的知识，部分Hook代码采用Frida 与 Unidbg 对照的方式，帮助熟悉Frida但不熟悉Unidbg的读者快速入门。样例前往百度云下载。</p>
<p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1ZRPtQrx4QAPEQhrpq6gbgg">https://pan.baidu.com/s/1ZRPtQrx4QAPEQhrpq6gbgg</a> 提取码：6666 </p>
</blockquote>
<h2 id="一、基础知识"><a href="#一、基础知识" class="headerlink" title="一、基础知识"></a>一、基础知识</h2><h3 id="1-获取SO基地址"><a href="#1-获取SO基地址" class="headerlink" title="1.获取SO基地址"></a>1.获取SO基地址</h3><h4 id="Ⅰfrida-获取基地址"><a href="#Ⅰfrida-获取基地址" class="headerlink" title="Ⅰfrida 获取基地址"></a>Ⅰfrida 获取基地址</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> baseAddr = Module.findBaseAddress(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Ⅱ-Unidbg-获取基地址"><a href="#Ⅱ-Unidbg-获取基地址" class="headerlink" title="Ⅱ Unidbg 获取基地址"></a>Ⅱ Unidbg 获取基地址</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载so到虚拟内存</span></span><br><span class="line">DalvikModule dm = vm.loadLibrary(<span class="string">&quot;libnative-lib.so&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 加载好的so对应为一个模块</span></span><br><span class="line"><span class="keyword">module</span> = dm.getModule();</span><br><span class="line"><span class="comment">// 打印libnative-lib.so在Unidbg虚拟内存中的基地址</span></span><br><span class="line">System.out.println(<span class="string">&quot;baseAddr:&quot;</span>+<span class="keyword">module</span>.base);</span><br></pre></td></tr></table></figure>

<p>加载了多个SO的情况</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取某个具体SO的句柄</span></span><br><span class="line">Module yourModule = emulator.getMemory().findModule(<span class="string">&quot;yourModuleName&quot;</span>);</span><br><span class="line"><span class="comment">// 打印其基地址</span></span><br><span class="line">System.out.println(<span class="string">&quot;baseAddr:&quot;</span>+yourModule.base);</span><br></pre></td></tr></table></figure>

<p>如果只主动加载一个SO，其基址恒为0x40000000 ,这是一个检测Unidbg的点，可以在 com/github/unidbg/memory/Memory.java 中做修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Memory</span> <span class="keyword">extends</span> <span class="title">IO</span>, <span class="title">Loader</span>, <span class="title">StackMemory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> STACK_BASE = <span class="number">0xc0000000L</span>;</span><br><span class="line">    <span class="keyword">int</span> STACK_SIZE_OF_PAGE = <span class="number">256</span>; <span class="comment">// 1024k</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 修改内存映射的起始地址</span></span><br><span class="line">    <span class="keyword">long</span> MMAP_BASE = <span class="number">0x40000000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">UnidbgPointer <span class="title">allocateStack</span><span class="params">(<span class="keyword">int</span> size)</span></span>;</span><br><span class="line">    <span class="function">UnidbgPointer <span class="title">pointer</span><span class="params">(<span class="keyword">long</span> address)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setStackPoint</span><span class="params">(<span class="keyword">long</span> sp)</span></span>;</span><br></pre></td></tr></table></figure>



<h3 id="2-获取函数地址"><a href="#2-获取函数地址" class="headerlink" title="2.获取函数地址"></a>2.获取函数地址</h3><h4 id="Ⅰ-Frida-获取导出函数地址"><a href="#Ⅰ-Frida-获取导出函数地址" class="headerlink" title="Ⅰ Frida 获取导出函数地址"></a>Ⅰ Frida 获取导出函数地址</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;strcmp&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="Ⅱ-Unidbg-获取导出函数地址"><a href="#Ⅱ-Unidbg-获取导出函数地址" class="headerlink" title="Ⅱ Unidbg 获取导出函数地址"></a>Ⅱ Unidbg 获取导出函数地址</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载so到虚拟内存</span></span><br><span class="line">DalvikModule dm = vm.loadLibrary(<span class="string">&quot;libnative-lib.so&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 加载好的 libscmain.so对应为一个模块</span></span><br><span class="line"><span class="keyword">module</span> = dm.getModule();</span><br><span class="line"><span class="keyword">int</span> address = (<span class="keyword">int</span>) <span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;funcNmae&quot;</span>).getAddress();</span><br></pre></td></tr></table></figure>

<h4 id="Ⅲ-Frida-获取非导出函数地址"><a href="#Ⅲ-Frida-获取非导出函数地址" class="headerlink" title="Ⅲ Frida 获取非导出函数地址"></a>Ⅲ Frida 获取非导出函数地址</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = Module.findBaseAddress(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> FuncAddr = soAddr.add(<span class="number">0x1768</span> + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Ⅳ-Unidbg-获取非导出函数地址"><a href="#Ⅳ-Unidbg-获取非导出函数地址" class="headerlink" title="Ⅳ Unidbg 获取非导出函数地址"></a>Ⅳ Unidbg 获取非导出函数地址</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载so到虚拟内存</span></span><br><span class="line">DalvikModule dm = vm.loadLibrary(<span class="string">&quot;libnative-lib.so&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 加载好的so对应为一个模块</span></span><br><span class="line"><span class="keyword">module</span> = dm.getModule();</span><br><span class="line"><span class="comment">// offset，在IDA中查看</span></span><br><span class="line"><span class="keyword">int</span> offset = <span class="number">0x1768</span>;</span><br><span class="line"><span class="comment">// 真实地址 = baseAddr + offset</span></span><br><span class="line"><span class="keyword">int</span> address = (<span class="keyword">int</span>) (<span class="keyword">module</span>.base + offset);</span><br></pre></td></tr></table></figure>

<p>Hook 非导出函数时，不管是Frida还是Unidbg都需要考虑thumb2下地址+1的问题。</p>
<h3 id="3-Unidbg-Hook-大盘点"><a href="#3-Unidbg-Hook-大盘点" class="headerlink" title="3.Unidbg Hook 大盘点"></a>3.Unidbg Hook 大盘点</h3><p>Unidbg 在Android 上支持两大类Hook方案</p>
<ul>
<li>Unidbg 内置的第三方Hook框架，包括xHook/Whale/HookZz</li>
<li>Unicorn Hook以及基于它封装的Console Debugger，主要就指Console Debugger。</li>
</ul>
<p><strong>第一类是Unidbg支持并内置的第三方Hook框架，有Dobby(前身HookZz)/Whale这样的Inline Hook框架，也有xHook这样的PLT Hook 框架，支持这些Hook框架的使用，证明了Unidbg确实相对完善。但支持Frida还有很远的路要走，Frida比Dobby或者xHook都复杂的多，使用到了多线程、信号处理等Unidbg尚不支持的机制。总体来说，Dobby + Whale + xHook 也绝对够用了，没有非Frida不可的需求。</strong></p>
<p><strong>第二类是Unicorn Hook，只有当Unidbg的底层引擎选择为Unicorn时（默认引擎），才能使用。Unicorn提供了各种级别和粒度的Hook，内存Hook/指令/基本块 Hook/异常Hook 等等，十分强大，Unidbg基于它封装了更便于使用的Console Debugger，Unidbg也支持IDA/GDB的联合调试，但仍处于实验性质，不建议尝试。</strong></p>
<p>该选择哪一类Hook方案？这得看使用Unidbg的目的。如果用于<strong>模拟执行</strong>，那么建议使用第一类Hook，为什么？这得从Unidbg支持的汇编执行引擎说起。Unidbg支持多种底层引擎，最早也是默认的引擎是Unicorn，从名字也能看出，Unidbg和Unicorn有很大关系。但后续Unidbg又支持了数个引擎，丰富了Unidbg的底层生态。但我们知道，任何提高程序复杂度的行为，肯定都为了解决什么问题。</p>
<p>hypervisor 引擎用于搭载了 <em>Apple Silicon</em> 芯片的设备；</p>
<p>KVM 引擎用于树莓派；</p>
<p>Dynarmic 引擎是为了更快的模拟执行；</p>
<p>Unicorn 是最强大最完善的模拟执行引擎，但它相比Dynarmic太慢了，同场景下，Dynarmic比Unicorn模拟执行快数倍甚至十数倍。因此在生产环境中，采用 Dynarmic 引擎配上  <strong><a target="_blank" rel="noopener" href="https://github.com/anjia0532/unidbg-boot-server">unidbg-boot-server</a></strong> 实现高并发。</p>
<p><em>Dynarmic引擎使用</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> AndroidEmulator <span class="title">createARMEmulator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> AndroidEmulatorBuilder.for32Bit()</span><br><span class="line">            <span class="comment">// 切换为Dynarmic引擎</span></span><br><span class="line">            .addBackendFactory(<span class="keyword">new</span> DynarmicFactory(<span class="keyword">true</span>))</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>Unicorn 默认引擎</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> AndroidEmulator <span class="title">createARMEmulator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> AndroidEmulatorBuilder.for32Bit()</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用Unidbg的第二个场景是<strong>辅助算法还原</strong>，即模拟执行只作为算法还原的前奏，在模拟执行输出结果无误后，再使用Unidbg辅助算法还原。这种情况下对执行速度要求不高，那肯定使用更强大的Unicorn引擎。这时候两大类Hook方案都可以使用，选择哪类？我倾向于自始至终使用第二类方案，即基于Unicorn Hook的方案。</p>
<p>我个人认为有三点优势</p>
<ul>
<li><p>HookZz或者xHook等方案，都可以基于其Hook实现原理进行检测，但Unicorn 原生Hook不容易被检测。</p>
</li>
<li><p>Unicorn Hook 没有局限，其他方案局限性较大。比如Inline Hook方案不能Hook短函数，或者两个相邻的地址；PLT Hook 不能 Hook Sub_xxx 子函数。</p>
</li>
<li><p>两类方案混用时，一定几率触发bug，事实上，单使用Unicorn的某些Hook功能都有bug，因此统一用原生Hook可以少一些bug。</p>
</li>
</ul>
<p>总结如下</p>
<h4 id="Ⅰ-以模拟执行为目的"><a href="#Ⅰ-以模拟执行为目的" class="headerlink" title="Ⅰ 以模拟执行为目的"></a>Ⅰ 以模拟执行为目的</h4><p>使用第三方Hook方案，arm32下HookZz的支持较好，arm64下Dobby的支持较好，HookZz/Dobby Hook不成功时，如果函数是导出函数就用xHook，否则使用 Whale。</p>
<h4 id="Ⅱ-以算法还原为目的"><a href="#Ⅱ-以算法还原为目的" class="headerlink" title="Ⅱ 以算法还原为目的"></a>Ⅱ 以算法还原为目的</h4><p>使用Console Debugger 和 Unicorn Hook，不优先使用第三方Hook方案。</p>
<h3 id="4-本篇的基础代码"><a href="#4-本篇的基础代码" class="headerlink" title="4.本篇的基础代码"></a>4.本篇的基础代码</h3><p>即模拟执行demo的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tutorial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Emulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.HookStatus;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.backend.Backend;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.backend.CodeHook;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.context.RegisterContext;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.debugger.BreakPointCallback;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.HookContext;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.ReplaceCallback;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.hookzz.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.whale.IWhale;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.whale.Whale;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.xhook.IxHook;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.XHookImpl;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.DalvikModule;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.DvmClass;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.DvmObject;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.VM;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.utils.Inspector;</span><br><span class="line"><span class="keyword">import</span> com.sun.jna.Pointer;</span><br><span class="line"><span class="keyword">import</span> unicorn.ArmConst;</span><br><span class="line"><span class="keyword">import</span> unicorn.Unicorn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">hookInUnidbg</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line"></span><br><span class="line">    hookInUnidbg() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建模拟器实例</span></span><br><span class="line">        emulator = AndroidEmulatorBuilder.for32Bit().build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟器的内存操作接口</span></span><br><span class="line">        <span class="keyword">final</span> Memory memory = emulator.getMemory();</span><br><span class="line">        <span class="comment">// 设置系统类库解析</span></span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> AndroidResolver(<span class="number">23</span>));</span><br><span class="line">        <span class="comment">// 创建Android虚拟机</span></span><br><span class="line">        vm = emulator.createDalvikVM(<span class="keyword">new</span> File(<span class="string">&quot;unidbg-android/src/test/resources/tutorial/hookinunidbg.apk&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//        emulator.attach().addBreakPoint(0x40000000+0xa80);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载so到虚拟内存</span></span><br><span class="line">        DalvikModule dm = vm.loadLibrary(<span class="string">&quot;hookinunidbg&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 加载好的 libhookinunidbg.so对应为一个模块</span></span><br><span class="line">        <span class="keyword">module</span> = dm.getModule();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行JNIOnLoad（如果有的话）</span></span><br><span class="line">        dm.callJNI_OnLoad(emulator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DvmClass dvmClass = vm.resolveClass(<span class="string">&quot;com/example/hookinunidbg/MainActivity&quot;</span>);</span><br><span class="line">        String methodSign = <span class="string">&quot;call()V&quot;</span>;</span><br><span class="line">        DvmObject&lt;?&gt; dvmObject = dvmClass.newObject(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        dvmObject.callJniMethodObject(emulator, methodSign);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        hookInUnidbg mydemo = <span class="keyword">new</span> hookInUnidbg();</span><br><span class="line">        mydemo.call();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行时有一些日志输出，为正常逻辑。</p>
<h2 id="二、Hook-函数"><a href="#二、Hook-函数" class="headerlink" title="二、Hook 函数"></a>二、Hook 函数</h2><p>demo hookInunidbg中运行了数个函数，在本节中关注其中运行的base64_encode函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">base64_encode</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *in, <span class="keyword">unsigned</span> <span class="keyword">int</span> inlen, <span class="keyword">char</span> *out)</span></span>;</span><br></pre></td></tr></table></figure>

<p>参数解释如下</p>
<blockquote>
<p>char *out：一块buffer的首地址，用来存放转码后的内容。</p>
<p>char *in：原字符串的首地址，指向原字符串内容。</p>
<p>int inlen：原字符串长度。</p>
<p>返回值：正常情况下返回转换后字符串的实际长度。</p>
</blockquote>
<p>本节的任务就是打印base64编码前的内容，以及编码后的内容。</p>
<h3 id="1-Frida"><a href="#1-Frida" class="headerlink" title="1.Frida"></a>1.Frida</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Frida Version</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// get base address of target so;</span></span><br><span class="line">    <span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="string">&quot;libhookinunidbg.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (base_addr)&#123;</span><br><span class="line">        <span class="keyword">var</span> func_addr = Module.findExportByName(<span class="string">&quot;libhookinunidbg.so&quot;</span>, <span class="string">&quot;base64_encode&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;hook base64_encode function&quot;</span>)</span><br><span class="line">        Interceptor.attach(func_addr,&#123;</span><br><span class="line">            <span class="comment">// 打印入参</span></span><br><span class="line">            <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;\n input:&quot;</span>)</span><br><span class="line">                <span class="built_in">this</span>.buffer = args[<span class="number">2</span>];</span><br><span class="line">                <span class="keyword">var</span> length = args[<span class="number">1</span>];</span><br><span class="line">                <span class="built_in">console</span>.log(hexdump(args[<span class="number">0</span>],&#123;<span class="attr">length</span>: length.toUInt32()&#125;))</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">// 打印返回值</span></span><br><span class="line">            <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot; output:&quot;</span>)</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="built_in">this</span>.buffer.readCString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure>

<h3 id="2-Console-Debugger"><a href="#2-Console-Debugger" class="headerlink" title="2.Console Debugger"></a>2.Console Debugger</h3><p>Console Debugger 是快速打击、快速验证的交互调试器，在call JNIOnLoad之前下断点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// debug</span></span><br><span class="line">emulator.attach().addBreakPoint(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;base64_encode&quot;</span>).getAddress());</span><br></pre></td></tr></table></figure>

<p>需要重申和强调几个概念</p>
<ul>
<li>运行到对应地址时触发断点，类似于GDB调试或者IDA调试，时机为<strong>目标指令执行前</strong>。</li>
<li>断点不具有函数的种种概念，需要从汇编指令的角度去理解函数。</li>
<li>Console Debugger 用于辅助算法分析，快速分析、确认某个函数的功能。在Unicorn 引擎下才可以用。</li>
</ul>
<p>针对第二条做补充</p>
<blockquote>
<p>根据ARM ATPCS调用约定，当参数个数小于等于4个的时候，子程序间通过R0~R3来传递参数（即R0-R3代表参数1-参数4），如果参数个数大于4个，余下的参数通过sp所指向的数据栈进行参数传递。而函数的返回值总是通过R0传递回来。</p>
</blockquote>
<p>以目标函数为例，函数调用前，调用方把三个参数依次放在R0-R2中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/404nofoundx/ImageCloud/2.png" alt="2"></p>
<p>立即数可以直接看，比如此处参数2是5。如果怀疑不是立即数而是指针，比如参数1和参数3，那么在交互调试中输入 mxx 查看其指向的内存，等价于Frida中的hexdump(xxx)。写法有两种，以此处r0为例，既可以 mr0 也可以 m0x400022e0 。</p>
<p>Unidbg 在数据展示上，相较于Frida Hexdump，有一些不同，体现在两方面</p>
<ul>
<li>Frida hexdump时，左侧基地址从当前地址开始，而Unidbg从0开始。</li>
<li>Unidbg 给出了所打印数据块的md5值，方便对比两块数据块内容是否一致，而且还展示数据的Hex String，方便在大量日志中搜索。</li>
</ul>
<p>Console Debugger 支持许多调试、分析的命令，如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">c: <span class="keyword">continue</span></span><br><span class="line">n: step over</span><br><span class="line">bt: back trace</span><br><span class="line"></span><br><span class="line">st hex: search stack</span><br><span class="line">shw hex: search writable heap</span><br><span class="line">shr hex: search readable heap</span><br><span class="line">shx hex: search executable heap</span><br><span class="line"></span><br><span class="line">nb: <span class="keyword">break</span> at next block</span><br><span class="line">s|<span class="built_in">si</span>: step into</span><br><span class="line">s[<span class="built_in">decimal</span>]: execute specified amount instruction</span><br><span class="line">s(blx): execute util BLX mnemonic, low performance</span><br><span class="line"></span><br><span class="line">m(op) [<span class="type">size</span>]: show memory, default size is <span class="number">0</span>x70, size may hex or decimal</span><br><span class="line">mr0<span class="literal">-mr7</span>, mfp, mip, msp [<span class="type">size</span>]: show memory of specified register</span><br><span class="line">m(address) [<span class="type">size</span>]: show memory of specified address, address must <span class="built_in">start</span> with <span class="number">0</span>x</span><br><span class="line"></span><br><span class="line">wr0<span class="literal">-wr7</span>, wfp, wip, wsp &lt;value&gt;: <span class="built_in">write</span> specified register</span><br><span class="line">wb(address), ws(address), wi(address) &lt;value&gt;: <span class="built_in">write</span> (byte, short, integer) memory of specified address, address must <span class="built_in">start</span> with <span class="number">0</span>x</span><br><span class="line">wx(address) &lt;hex&gt;: <span class="built_in">write</span> bytes to memory at specified address, address must <span class="built_in">start</span> with <span class="number">0</span>x</span><br><span class="line"></span><br><span class="line">b(address): add temporarily breakpoint, address must <span class="built_in">start</span> with <span class="number">0</span>x, can be module offset</span><br><span class="line">b: add breakpoint of register PC</span><br><span class="line"><span class="built_in">r</span>: remove breakpoint of register PC</span><br><span class="line">blr: add temporarily breakpoint of register LR</span><br><span class="line"></span><br><span class="line">p (assembly): patch assembly at PC address</span><br><span class="line"><span class="built_in">where</span>: show java stack trace</span><br><span class="line"></span><br><span class="line">trace [<span class="type">begin</span> <span class="type">end</span>]: <span class="built_in">Set</span> trace instructions</span><br><span class="line">traceRead [<span class="type">begin</span> <span class="type">end</span>]: <span class="built_in">Set</span> trace memory read</span><br><span class="line">traceWrite [<span class="type">begin</span> <span class="type">end</span>]: <span class="built_in">Set</span> trace memory <span class="built_in">write</span></span><br><span class="line">vm: view loaded modules</span><br><span class="line">vbs: view breakpoints</span><br><span class="line">d|dis: show disassemble</span><br><span class="line">d(<span class="number">0</span>x): show disassemble at specify address</span><br><span class="line">stop: stop emulation</span><br><span class="line">run [<span class="type">arg</span>]: run test</span><br><span class="line">cc size: convert asm from <span class="number">0</span>x400008a0 - <span class="number">0</span>x400008a0 + size bytes to c function</span><br></pre></td></tr></table></figure>

<p>在Frida代码中，用 <code>console.log(hexdump(args[0],&#123;length: args[1].toUInt32()&#125;))</code>来打印 <strong>参数1指向的内存块，长度为参数2的值</strong> ，Unidbg中同样可以指定长度。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mr0 <span class="number">5</span></span><br><span class="line"></span><br><span class="line">&gt;-----------------------------------------------------------------------------&lt;</span><br><span class="line">[<span class="number">23</span>:<span class="number">41</span>:<span class="number">37</span> <span class="number">891</span>]r0=RX@<span class="number">0</span>x400022e0[<span class="type">libhookinunidbg.so</span>]<span class="number">0</span>x22e0, md5=f5704182e75d12316f5b729e89a499df, hex=<span class="number">6</span>c696c6163</span><br><span class="line">size: <span class="number">5</span></span><br><span class="line"><span class="number">0000</span>: <span class="number">6</span>C <span class="number">69</span> <span class="number">6</span>C <span class="number">61</span> <span class="number">63</span>                                     lilac</span><br><span class="line">^-----------------------------------------------------------------------------^</span><br></pre></td></tr></table></figure>

<p>目前Console Debugger 还不支持 <em>mr0 r1</em>这样的语法。</p>
<p>至此实现了Frida OnEnter的功能，接下来要获取OnLeave即函数执行完的时机。在ARM编程中，LR寄存器存放了程序的返回地址，当函数跑到LR所指向的地址时，意味着函数结束跳转了出来。又因为断点是在目标地址执行前触发，所以在LR处的断点断下时，目标函数执行完且刚执行完，这就是Frida OnLeave 时机点的原理。在Console Debugger交互调试中，使用 blr 命令可以在 lr 处下一个临时断点，它只会触发一次。</p>
<p>整体逻辑如下</p>
<ul>
<li>在目标函数的地址处下断点</li>
<li>运行到断点处，进入Console Debugger 交互调试</li>
<li>mxx 系列查看参数</li>
<li>blr 在函数返回处下断点</li>
<li>c 使程序继续运行，到返回值处断下</li>
<li>查看此时的buffer</li>
</ul>
<p>需要注意的是，在onLeave时机中通过mr2查看入参3是胡闹。R2只在程序入口处表示参数3，在函数运算的过程中，R2作为通用寄存器被用于存储、运算，它已经不是指向buffer的地址了。在Frida中也存在这个问题，所以我们在OnEnter里将args[2]即R2的值保存在this.buffer中，OnLeave中再取出来打印。而在Console Debugger交互调试中，办法更简单粗暴——鼠标往上拉一下，看看原来r2的值是什么，发现是0x401d2000，然后m0x401d2000即可。</p>
<p>这样我们就实现了Frida的等价功能。似乎有点麻烦，但熟练后你会发现Console Debugger 是最快最稳的Hook &amp; Debug 工具。除此之外，当函数被调用了三五百次时，我们不希望它反复停下来，然后不停“c”来继续运行。Console Debugger 也可以做持久化的Hook，代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HookByConsoleDebugger</span><span class="params">()</span></span>&#123;</span><br><span class="line">    emulator.attach().addBreakPoint(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;base64_encode&quot;</span>).getAddress(), <span class="keyword">new</span> BreakPointCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">long</span> address)</span> </span>&#123;</span><br><span class="line">            RegisterContext context = emulator.getContext();</span><br><span class="line">            Pointer input = context.getPointerArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">int</span> length = context.getIntArg(<span class="number">1</span>);</span><br><span class="line">            Pointer buffer = context.getPointerArg(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">            Inspector.inspect(input.getByteArray(<span class="number">0</span>, length), <span class="string">&quot;base64 input&quot;</span>);</span><br><span class="line">            <span class="comment">// OnLeave</span></span><br><span class="line">            emulator.attach().addBreakPoint(context.getLRPointer().peer, <span class="keyword">new</span> BreakPointCallback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">long</span> address)</span> </span>&#123;</span><br><span class="line">                    <span class="comment">// onHit返回ture时，断点触发时不会进入交互界面；为false时会。</span></span><br><span class="line">                    String result = buffer.getString(<span class="number">0</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;base64 result:&quot;</span>+result);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-第三方Hook框架"><a href="#3-第三方Hook框架" class="headerlink" title="3.第三方Hook框架"></a>3.第三方Hook框架</h3><p>如下目标函数均在JNIOnLoad前调用</p>
<h4 id="ⅠxHook"><a href="#ⅠxHook" class="headerlink" title="ⅠxHook"></a>ⅠxHook</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HookByXhook</span><span class="params">()</span></span>&#123;</span><br><span class="line">    IxHook xHook = XHookImpl.getInstance(emulator);</span><br><span class="line">    xHook.register(<span class="string">&quot;libhookinunidbg.so&quot;</span>, <span class="string">&quot;base64_encode&quot;</span>, <span class="keyword">new</span> ReplaceCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> HookStatus <span class="title">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="keyword">long</span> originFunction)</span> </span>&#123;</span><br><span class="line">            Pointer input = context.getPointerArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">int</span> length = context.getIntArg(<span class="number">1</span>);</span><br><span class="line">            Pointer buffer = context.getPointerArg(<span class="number">2</span>);</span><br><span class="line">            Inspector.inspect(input.getByteArray(<span class="number">0</span>, length), <span class="string">&quot;base64 input&quot;</span>);</span><br><span class="line">            context.push(buffer);</span><br><span class="line">            <span class="keyword">return</span> HookStatus.RET(emulator, originFunction);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context)</span> </span>&#123;</span><br><span class="line">            Pointer buffer = context.pop();</span><br><span class="line">            System.out.println(<span class="string">&quot;base64 result:&quot;</span>+buffer.getString(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 使其生效</span></span><br><span class="line">    xHook.refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>xHook是爱奇艺开源的Android PLT hook框架，优点是挺稳定好用，缺点是不能Hook Sub_xxx 子函数。这是其原理所限。</p>
<h4 id="Ⅱ-HookZz"><a href="#Ⅱ-HookZz" class="headerlink" title="Ⅱ HookZz"></a>Ⅱ HookZz</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HookByHookZz</span><span class="params">()</span></span>&#123;</span><br><span class="line">    IHookZz hookZz = HookZz.getInstance(emulator); <span class="comment">// 加载HookZz，支持inline hook</span></span><br><span class="line">    hookZz.enable_arm_arm64_b_branch(); <span class="comment">// 测试enable_arm_arm64_b_branch，可有可无</span></span><br><span class="line">    hookZz.wrap(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;base64_encode&quot;</span>), <span class="keyword">new</span> WrapCallback&lt;HookZzArm32RegisterContext&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext context, HookEntryInfo info)</span> </span>&#123;</span><br><span class="line">            Pointer input = context.getPointerArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">int</span> length = context.getIntArg(<span class="number">1</span>);</span><br><span class="line">            Pointer buffer = context.getPointerArg(<span class="number">2</span>);</span><br><span class="line">            Inspector.inspect(input.getByteArray(<span class="number">0</span>, length), <span class="string">&quot;base64 input&quot;</span>);</span><br><span class="line">            context.push(buffer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext context, HookEntryInfo info)</span> </span>&#123;</span><br><span class="line">            Pointer buffer = context.pop();</span><br><span class="line">            System.out.println(<span class="string">&quot;base64 result:&quot;</span>+buffer.getString(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    hookZz.disable_arm_arm64_b_branch();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HookZz 也可以实现类似于单行断点的Hook，但在Unidbg 的Hook大环境下感觉用处不大，不建议使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IHookZz hookZz = HookZz.getInstance(emulator);</span><br><span class="line">hookZz.instrument(<span class="keyword">module</span>.base + <span class="number">0x978</span> + <span class="number">1</span>, <span class="keyword">new</span> InstrumentCallback&lt;RegisterContext&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dbiCall</span><span class="params">(Emulator&lt;?&gt; emulator, RegisterContext ctx, HookEntryInfo info)</span> </span>&#123;</span><br><span class="line">        System.out.println(ctx.getIntArg(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>HookZz是老名字，现在叫Dobby，Unidbg中HookZz和Dobby是两个独立的Hook库，因为Unidbg作者认为HookZz在arm32上支持较好，Dobby在arm64上支持较好。HookZz或者说Dobby采用的是inline hook方案，因此可以Hook Sub_xxx，缺点是短函数可能出bug，受限于其 inline Hook 原理。</p>
<h4 id="Ⅲ-Whale"><a href="#Ⅲ-Whale" class="headerlink" title="Ⅲ Whale"></a>Ⅲ Whale</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HookByWhale</span><span class="params">()</span></span>&#123;</span><br><span class="line">    IWhale whale = Whale.getInstance(emulator);</span><br><span class="line">    whale.inlineHookFunction(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;base64_encode&quot;</span>), <span class="keyword">new</span> ReplaceCallback() &#123;</span><br><span class="line">        Pointer buffer;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> HookStatus <span class="title">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">long</span> originFunction)</span> </span>&#123;</span><br><span class="line">            RegisterContext context = emulator.getContext();</span><br><span class="line">            Pointer input = context.getPointerArg(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">int</span> length = context.getIntArg(<span class="number">1</span>);</span><br><span class="line">            buffer = context.getPointerArg(<span class="number">2</span>);</span><br><span class="line">            Inspector.inspect(input.getByteArray(<span class="number">0</span>, length), <span class="string">&quot;base64 input&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> HookStatus.RET(emulator, originFunction);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;base64 result:&quot;</span>+buffer.getString(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Whale 是一个跨平台的Hook框架，在Andorid Native Hook 上也是inline Hook方案，具体情况我了解不多。</p>
<h3 id="4-Unicorn-Hook"><a href="#4-Unicorn-Hook" class="headerlink" title="4.Unicorn Hook"></a>4.Unicorn Hook</h3><p>如果想对某个函数进行集中的、高强度的、同时又灵活的调试，Unicorn CodeHook是一个好选择。比如我想查看目标函数第一条指令的r1，第二条指令的r2，第三条指令的r3，类似于这种需求。</p>
<p>hook_add_new 第一个参数是Hook回调，我们这里选择CodeHook，它是逐条指令Hook，参数2是起始地址，参数3是结束地址，参数4一般填null。这意味着从起始地址到终止地址这个执行范围内的每条指令，我们都可以在其执行前处理它。</p>
<p>找到目标函数的代码范围</p>
<p><img src="https://cdn.jsdelivr.net/gh/404nofoundx/ImageCloud/3.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HookByUnicorn</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> start = <span class="keyword">module</span>.base+<span class="number">0x97C</span>;</span><br><span class="line">    <span class="keyword">long</span> end = <span class="keyword">module</span>.base+<span class="number">0x97C</span>+<span class="number">0x17A</span>;</span><br><span class="line">    emulator.getBackend().hook_add_new(<span class="keyword">new</span> CodeHook() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hook</span><span class="params">(Backend backend, <span class="keyword">long</span> address, <span class="keyword">int</span> size, Object user)</span> </span>&#123;</span><br><span class="line">            RegisterContext registerContext = emulator.getContext();</span><br><span class="line">            <span class="keyword">if</span>(address == <span class="keyword">module</span>.base + <span class="number">0x97C</span>)&#123;</span><br><span class="line">                <span class="keyword">int</span> r0 = registerContext.getIntByReg(ArmConst.UC_ARM_REG_R0);</span><br><span class="line">                System.out.println(<span class="string">&quot;0x97C 处 r0:&quot;</span>+Integer.toHexString(r0));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(address == <span class="keyword">module</span>.base + <span class="number">0x97C</span> + <span class="number">2</span>)&#123;</span><br><span class="line">                <span class="keyword">int</span> r2 = registerContext.getIntByReg(ArmConst.UC_ARM_REG_R2);</span><br><span class="line">                System.out.println(<span class="string">&quot;0x97C +2 处 r2:&quot;</span>+Integer.toHexString(r2));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(address == <span class="keyword">module</span>.base + <span class="number">0x97C</span> + <span class="number">4</span>)&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> r4 = registerContext.getIntByReg(ArmConst.UC_ARM_REG_R4);</span><br><span class="line">                System.out.println(<span class="string">&quot;0x97C +4 处 r4:&quot;</span>+Integer.toHexString(r4));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttach</span><span class="params">(Unicorn.UnHook unHook)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detach</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, start, end, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、Replace-参数和返回值"><a href="#三、Replace-参数和返回值" class="headerlink" title="三、Replace 参数和返回值"></a>三、Replace 参数和返回值</h2><h3 id="1-替换参数"><a href="#1-替换参数" class="headerlink" title="1.替换参数"></a>1.替换参数</h3><p>需求：入参改为hello world，对应的入参长度也要改，正确结果是 **aGVsbG8gd29ybGQ=**，供验证效果。</p>
<h4 id="ⅠFrida"><a href="#ⅠFrida" class="headerlink" title="ⅠFrida"></a>ⅠFrida</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Frida Version</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// get base address of target so;</span></span><br><span class="line">    <span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="string">&quot;libhookinunidbg.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (base_addr)&#123;</span><br><span class="line">        <span class="keyword">var</span> func_addr = Module.findExportByName(<span class="string">&quot;libhookinunidbg.so&quot;</span>, <span class="string">&quot;base64_encode&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;hook base64_encode function&quot;</span>)</span><br><span class="line">        <span class="keyword">var</span> fakeinput = <span class="string">&quot;hello world&quot;</span></span><br><span class="line">        <span class="keyword">var</span> fakeinputPtr = Memory.allocUtf8String(fakeinput);</span><br><span class="line">        Interceptor.attach(func_addr,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">                args[<span class="number">0</span>] = fakeinputPtr;</span><br><span class="line">                args[<span class="number">1</span>] = ptr(fakeinput.length);</span><br><span class="line">                <span class="built_in">this</span>.buffer = args[<span class="number">2</span>];</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">// 打印返回值</span></span><br><span class="line">            <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot; output:&quot;</span>)</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="built_in">this</span>.buffer.readCString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure>

<h4 id="Ⅱ-Console-Debugger"><a href="#Ⅱ-Console-Debugger" class="headerlink" title="Ⅱ Console Debugger"></a>Ⅱ Console Debugger</h4><p>Console Debugger 如何实现这一目标？</p>
<p>①下断点，运行代码后进入debugger</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emulator.attach().addBreakPoint(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;base64_encode&quot;</span>).getAddress());</span><br></pre></td></tr></table></figure>

<p>②通过命令修改参数1和2，字符串得通过hexstring的形式传入</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wx0x40002403 <span class="number">68656</span>c6c6f20776f726c64</span><br><span class="line"></span><br><span class="line">&gt;-----------------------------------------------------------------------------&lt;</span><br><span class="line">[<span class="number">14</span>:<span class="number">06</span>:<span class="number">46</span> <span class="number">165</span>]RX@<span class="number">0</span>x40002403[<span class="type">libhookinunidbg.so</span>]<span class="number">0</span>x2403, md5=<span class="number">5</span>eb63bbbe01eeed093cb22bb8f5acdc3, hex=<span class="number">68656</span>c6c6f20776f726c64</span><br><span class="line">size: <span class="number">11</span></span><br><span class="line"><span class="number">0000</span>: <span class="number">68</span> <span class="number">65</span> <span class="number">6</span>C <span class="number">6</span>C <span class="number">6</span>F <span class="number">20</span> <span class="number">77</span> <span class="number">6</span>F <span class="number">72</span> <span class="number">6</span>C <span class="number">64</span>                   hello world</span><br><span class="line">^-----------------------------------------------------------------------------^</span><br><span class="line">wr1 <span class="number">11</span></span><br><span class="line">&gt;&gt;&gt; r1=<span class="number">0</span>xb</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Console Debugger 支持下列写操作</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wr0<span class="literal">-wr7</span>, wfp, wip, wsp &lt;value&gt;: <span class="built_in">write</span> specified register</span><br><span class="line">wb(address), ws(address), wi(address) &lt;value&gt;: <span class="built_in">write</span> (byte, short, integer) memory of specified address, address must <span class="built_in">start</span> with <span class="number">0</span>x</span><br><span class="line">wx(address) &lt;hex&gt;: <span class="built_in">write</span> bytes to memory at specified address, address must <span class="built_in">start</span> with <span class="number">0</span>x</span><br></pre></td></tr></table></figure>

<p>但这其实并不方便，还是做持久化比较舒服。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReplaceArgByConsoleDebugger</span><span class="params">()</span></span>&#123;</span><br><span class="line">    emulator.attach().addBreakPoint(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;base64_encode&quot;</span>).getAddress(), <span class="keyword">new</span> BreakPointCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">long</span> address)</span> </span>&#123;</span><br><span class="line">            RegisterContext context = emulator.getContext();</span><br><span class="line">            String fakeInput = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">            <span class="keyword">int</span> length = fakeInput.length();</span><br><span class="line">            <span class="comment">// 修改r1值为新长度</span></span><br><span class="line">            emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R1, length);</span><br><span class="line">            MemoryBlock fakeInputBlock = emulator.getMemory().malloc(length, <span class="keyword">true</span>);</span><br><span class="line">            fakeInputBlock.getPointer().write(fakeInput.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            <span class="comment">// 修改r0为指向新字符串的新指针</span></span><br><span class="line">            emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R0, fakeInputBlock.getPointer().peer);</span><br><span class="line"></span><br><span class="line">            Pointer buffer = context.getPointerArg(<span class="number">2</span>);</span><br><span class="line">            <span class="comment">// OnLeave</span></span><br><span class="line">            emulator.attach().addBreakPoint(context.getLRPointer().peer, <span class="keyword">new</span> BreakPointCallback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">long</span> address)</span> </span>&#123;</span><br><span class="line">                    String result = buffer.getString(<span class="number">0</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;base64 result:&quot;</span>+result);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Ⅲ-第三方Hook框架"><a href="#Ⅲ-第三方Hook框架" class="headerlink" title="Ⅲ 第三方Hook框架"></a>Ⅲ 第三方Hook框架</h4><p>原理和Unicorn Hook完全不同，但得益于良好的封装，代码是类似的。</p>
<p>① xHook</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReplaceArgByXhook</span><span class="params">()</span></span>&#123;</span><br><span class="line">    IxHook xHook = XHookImpl.getInstance(emulator);</span><br><span class="line">    xHook.register(<span class="string">&quot;libhookinunidbg.so&quot;</span>, <span class="string">&quot;base64_encode&quot;</span>, <span class="keyword">new</span> ReplaceCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> HookStatus <span class="title">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="keyword">long</span> originFunction)</span> </span>&#123;</span><br><span class="line">            String fakeInput = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">            <span class="keyword">int</span> length = fakeInput.length();</span><br><span class="line">            <span class="comment">// 修改r1值为新长度</span></span><br><span class="line">            emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R1, length);</span><br><span class="line">            MemoryBlock fakeInputBlock = emulator.getMemory().malloc(length, <span class="keyword">true</span>);</span><br><span class="line">            fakeInputBlock.getPointer().write(fakeInput.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            <span class="comment">// 修改r0为指向新字符串的新指针</span></span><br><span class="line">            emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R0, fakeInputBlock.getPointer().peer);</span><br><span class="line"></span><br><span class="line">            Pointer buffer = context.getPointerArg(<span class="number">2</span>);</span><br><span class="line">            context.push(buffer);</span><br><span class="line">            <span class="keyword">return</span> HookStatus.RET(emulator, originFunction);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context)</span> </span>&#123;</span><br><span class="line">            Pointer buffer = context.pop();</span><br><span class="line">            System.out.println(<span class="string">&quot;base64 result:&quot;</span>+buffer.getString(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 使其生效</span></span><br><span class="line">    xHook.refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>② HookZz</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReplaceArgByHookZz</span><span class="params">()</span></span>&#123;</span><br><span class="line">    IHookZz hookZz = HookZz.getInstance(emulator); <span class="comment">// 加载HookZz，支持inline hook</span></span><br><span class="line">    hookZz.enable_arm_arm64_b_branch(); <span class="comment">// 测试enable_arm_arm64_b_branch，可有可无</span></span><br><span class="line">    hookZz.wrap(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;base64_encode&quot;</span>), <span class="keyword">new</span> WrapCallback&lt;HookZzArm32RegisterContext&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext context, HookEntryInfo info)</span> </span>&#123;</span><br><span class="line">            Pointer input = context.getPointerArg(<span class="number">0</span>);</span><br><span class="line">            String fakeInput = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">            input.setString(<span class="number">0</span>, fakeInput);</span><br><span class="line">            context.setR1(fakeInput.length());</span><br><span class="line"></span><br><span class="line">            Pointer buffer = context.getPointerArg(<span class="number">2</span>);</span><br><span class="line">            context.push(buffer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext context, HookEntryInfo info)</span> </span>&#123;</span><br><span class="line">            Pointer buffer = context.pop();</span><br><span class="line">            System.out.println(<span class="string">&quot;base64 result:&quot;</span>+buffer.getString(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    hookZz.disable_arm_arm64_b_branch();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为可以用HookZzArm32RegisterContext，相对来说代码简单一些。</p>
<h3 id="2-修改返回值"><a href="#2-修改返回值" class="headerlink" title="2.修改返回值"></a>2.修改返回值</h3><p>修改返回值的逻辑和替换参数并没什么区别，但它可以引出第四节，所以还是仔细讲一下。</p>
<p>在demo 中，有一个verifyApkSign函数，它总是返回1，并导致APK校验失败，因此目标就是让它返回0。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_hookinunidbg_MainActivity_call</span><span class="params">(JNIEnv *env, jobject thiz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> verifyret = <span class="built_in">verifyApkSign</span>();</span><br><span class="line">    <span class="keyword">if</span>(verifyret == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;APK sign verify failed!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;APK sign verify success!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">testBase64</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="keyword">int</span> <span class="title">verifyApkSign</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">LOGE</span>(<span class="string">&quot;verify apk sign&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="ⅠFrida-1"><a href="#ⅠFrida-1" class="headerlink" title="ⅠFrida"></a>ⅠFrida</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Frida Version</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// get base address of target so;</span></span><br><span class="line">    <span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="string">&quot;libhookinunidbg.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (base_addr)&#123;</span><br><span class="line">        <span class="keyword">var</span> func_addr = Module.findExportByName(<span class="string">&quot;libhookinunidbg.so&quot;</span>, <span class="string">&quot;verifyApkSign&quot;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;hook verifyApkSign function&quot;</span>)</span><br><span class="line">        Interceptor.attach(func_addr,&#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 修改返回值为0</span></span><br><span class="line">                retval.replace(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure>

<h4 id="Ⅱ-Console-Debugger-1"><a href="#Ⅱ-Console-Debugger-1" class="headerlink" title="Ⅱ Console Debugger"></a>Ⅱ Console Debugger</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReplaceRetByConsoleDebugger</span><span class="params">()</span></span>&#123;</span><br><span class="line">    emulator.attach().addBreakPoint(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;verifyApkSign&quot;</span>).getAddress(), <span class="keyword">new</span> BreakPointCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">long</span> address)</span> </span>&#123;</span><br><span class="line">            RegisterContext context = emulator.getContext();</span><br><span class="line">            <span class="comment">// OnLeave</span></span><br><span class="line">            emulator.attach().addBreakPoint(context.getLRPointer().peer, <span class="keyword">new</span> BreakPointCallback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">long</span> address)</span> </span>&#123;</span><br><span class="line">                    <span class="comment">// 修改返回值为0</span></span><br><span class="line">                    emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R0, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的Hook生效了，但 verifyApkSign 函数里的log 还是打印出来了。在一些情况中，我们并不希望函数执行本来的逻辑，这就引出了第四节，即需要彻底的函数替换——替换并使用自己的函数。</p>
<h2 id="四、替换函数"><a href="#四、替换函数" class="headerlink" title="四、替换函数"></a>四、替换函数</h2><h3 id="1-Frida-1"><a href="#1-Frida-1" class="headerlink" title="1.Frida"></a>1.Frida</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> verifyApkSignPtr = Module.findExportByName(<span class="string">&quot;libhookinunidbg.so&quot;</span>, <span class="string">&quot;verifyApkSign&quot;</span>);</span><br><span class="line">Interceptor.replace(verifyApkSignPtr, <span class="keyword">new</span> NativeCallback(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;replace verifyApkSign Function&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;, <span class="string">&#x27;void&#x27;</span>, []));</span><br></pre></td></tr></table></figure>

<p>Frida 这部分门道还挺多，但不是我们这里的重点。</p>
<h3 id="2-第三方Hook框架"><a href="#2-第三方Hook框架" class="headerlink" title="2.第三方Hook框架"></a>2.第三方Hook框架</h3><p>这里只演示xHook</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReplaceFuncByHookZz</span><span class="params">()</span></span>&#123;</span><br><span class="line">    HookZz hook = HookZz.getInstance(emulator);</span><br><span class="line">    hook.replace(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;verifyApkSign&quot;</span>).getAddress(), <span class="keyword">new</span> ReplaceCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> HookStatus <span class="title">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="keyword">long</span> originFunction)</span> </span>&#123;</span><br><span class="line">            emulator.getBackend().reg_write(Unicorn.UC_ARM_REG_R0,<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> HookStatus.RET(emulator,context.getLR());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>xHook的版本很清晰易懂，我们做了两件事</p>
<ul>
<li>R0 赋值为0</li>
<li>LR 赋值给 PC，这意味着函数一行不执行就返回了，又因为R0赋值0所以返回值为0。</li>
</ul>
<h3 id="3-Console-Debugger"><a href="#3-Console-Debugger" class="headerlink" title="3.Console Debugger"></a>3.Console Debugger</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ReplaceFuncByConsoleDebugger</span><span class="params">()</span></span>&#123;</span><br><span class="line">    emulator.attach().addBreakPoint(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;verifyApkSign&quot;</span>).getAddress(), <span class="keyword">new</span> BreakPointCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">long</span> address)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;替换函数 verifyApkSign&quot;</span>);</span><br><span class="line">            RegisterContext registerContext = emulator.getContext();</span><br><span class="line">            emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_PC, registerContext.getLRPointer().peer);</span><br><span class="line">            emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R0, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>非常清晰易懂。</p>
<h2 id="五、Call-函数"><a href="#五、Call-函数" class="headerlink" title="五、Call 函数"></a>五、Call 函数</h2><p>分析具体算法时，常需要对其进行主动调用，进行更灵活和细致的分析。举两个例子</p>
<p>1是主动调用base64_encode 函数</p>
<p>2是一个更复杂一些的函数。</p>
<h3 id="1-Frida-2"><a href="#1-Frida-2" class="headerlink" title="1.Frida"></a>1.Frida</h3><h3 id="2-Unidbg"><a href="#2-Unidbg" class="headerlink" title="2.Unidbg"></a>2.Unidbg</h3><h2 id="六、Patch-与内存检索"><a href="#六、Patch-与内存检索" class="headerlink" title="六、Patch 与内存检索"></a>六、Patch 与内存检索</h2><h3 id="1-Patch"><a href="#1-Patch" class="headerlink" title="1.Patch"></a>1.Patch</h3><p>Patch 就是直接对二进制文件进行修改，Patch本质上只有两种形式</p>
<ul>
<li>patch 二进制文件</li>
<li>在内存里 patch</li>
</ul>
<p>Patch的应用场景很多，有时候比Hook更简单好用，所以要介绍它。Patch 二进制文件大家都很熟悉，在IDA中使用KeyPatch即可。但这里我们关注内存Patch。</p>
<p><img src="https://cdn.jsdelivr.net/gh/404nofoundx/ImageCloud/6.png"></p>
<p>0x8CA处调用了签名校验函数，第三四节中通过Replace返回值或函数的方式来处理它，但实际上，修改0x8CA处这条四字节指令也是好办法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/404nofoundx/ImageCloud/7.png" alt="image-20211103211850263"></p>
<p>需要注意的是，本文只讨论了arm32，指令集只考虑最常见的thumb2，arm以及arm64可以自行测试。</p>
<h4 id="ⅠFrida-2"><a href="#ⅠFrida-2" class="headerlink" title="ⅠFrida"></a>ⅠFrida</h4><p>①方法一</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var str_name_so = &quot;libhookinunidbg.so&quot;;    //要hook的so名</span><br><span class="line">var n_addr_func_offset = 0x8CA;         //要hook的函数在函数里面的偏移,thumb要+1</span><br><span class="line"></span><br><span class="line">var n_addr_so = Module.findBaseAddress(str_name_so);</span><br><span class="line">var n_addr_assemble = n_addr_so.add(n_addr_func_offset);</span><br><span class="line"></span><br><span class="line">Memory.protect(n_addr_assemble, 4, &#x27;rwx&#x27;); // 修改内存属性,使程序段可写</span><br><span class="line">n_addr_assemble.writeByteArray([0x00, 0x20, 0x00, 0xBF]);</span><br></pre></td></tr></table></figure>

<p>但这并不是最佳代码，Patch存在两个问题</p>
<ul>
<li>是否存在多个线程同时读写这块内存？是否有冲突</li>
<li>arm 的缓存刷新机制</li>
</ul>
<p>所以Frida 提供了更安全可靠的API来修改内存中的字节</p>
<p>②方法二</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> str_name_so = <span class="string">&quot;libhookinunidbg.so&quot;</span>;    <span class="comment">//要hook的so名</span></span><br><span class="line"><span class="keyword">var</span> n_addr_func_offset = <span class="number">0x8CA</span>;         <span class="comment">//要hook的函数在函数里面的偏移,thumb要+1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> n_addr_so = Module.findBaseAddress(str_name_so);</span><br><span class="line"><span class="keyword">var</span> n_addr_assemble = n_addr_so.add(n_addr_func_offset);</span><br><span class="line"></span><br><span class="line"><span class="comment">// safely modify bytes at address</span></span><br><span class="line">Memory.patchCode(n_addr_assemble, <span class="number">4</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 以 thumb的方式获取一个patch对象</span></span><br><span class="line">    <span class="keyword">var</span> cw = <span class="keyword">new</span> ThumbWriter(n_addr_assemble);</span><br><span class="line">    <span class="comment">// 小端序</span></span><br><span class="line">    <span class="comment">// 00 20</span></span><br><span class="line">    cw.putInstruction(<span class="number">0x2000</span>)</span><br><span class="line">    <span class="comment">// 00 BF</span></span><br><span class="line">    cw.putInstruction(<span class="number">0xBF00</span>);</span><br><span class="line">    cw.flush(); <span class="comment">// 内存刷新</span></span><br><span class="line">    <span class="built_in">console</span>.log(hexdump(n_addr_assemble))</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="Ⅱ-Unidbg"><a href="#Ⅱ-Unidbg" class="headerlink" title="Ⅱ Unidbg"></a>Ⅱ Unidbg</h4><p>Unidbg在修改内存上，既可以传机器码，也可以传汇编指令，方法一和方法二其实没区别。</p>
<p>①方法一</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Patch1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 00 20 00 bf</span></span><br><span class="line">    <span class="keyword">int</span> patchCode = <span class="number">0xBF002000</span>; <span class="comment">// movs r0,0</span></span><br><span class="line">    emulator.getMemory().pointer(<span class="keyword">module</span>.base + <span class="number">0x8CA</span>).setInt(<span class="number">0</span>,patchCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>②方法二</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Patch2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] patchCode = &#123;<span class="number">0x00</span>, <span class="number">0x20</span>, <span class="number">0x00</span>, (<span class="keyword">byte</span>) <span class="number">0xBF</span>&#125;;</span><br><span class="line">    emulator.getBackend().mem_write(<span class="keyword">module</span>.base + <span class="number">0x8CA</span>, patchCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>③方法三</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Patch3</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> (Keystone keystone = <span class="keyword">new</span> Keystone(KeystoneArchitecture.Arm, KeystoneMode.ArmThumb)) &#123;</span><br><span class="line">        KeystoneEncoded encoded = keystone.assemble(<span class="string">&quot;movs r0,0;nop&quot;</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] patchCode = encoded.getMachineCode();</span><br><span class="line">        emulator.getMemory().pointer(<span class="keyword">module</span>.base + <span class="number">0x8CA</span>).write(<span class="number">0</span>, patchCode, <span class="number">0</span>, patchCode.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-内存检索"><a href="#2-内存检索" class="headerlink" title="2.内存检索"></a>2.内存检索</h3><p>假设SO存在碎片化，比如要分析某个SO的多个版本，需要Patch签名校验或者某处汇编，其地址在不同版本中不一样，而且不是导出函数。内存检索+Patch就是一个好办法，可以很好适应多版本、碎片化。</p>
<p>搜索特征片段，可能是搜索函数开头十字节，也可能是搜索目标地址上下字节或者其他特征。</p>
<p><img src="https://cdn.jsdelivr.net/gh/404nofoundx/ImageCloud/8.png" alt="image-20211103214819755"></p>
<h4 id="ⅠFrida-3"><a href="#ⅠFrida-3" class="headerlink" title="ⅠFrida"></a>ⅠFrida</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">searchAndPatch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = Process.findModuleByName(<span class="string">&quot;libhookinunidbg.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> pattern = <span class="string">&quot;80 b5 6f 46 84 b0 03 90 02 91&quot;</span></span><br><span class="line">    <span class="keyword">var</span> matches = Memory.scanSync(<span class="built_in">module</span>.base, <span class="built_in">module</span>.size, pattern);</span><br><span class="line">    <span class="built_in">console</span>.log(matches.length)</span><br><span class="line">    <span class="keyword">if</span> (matches.length !== <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> n_addr_assemble = matches[<span class="number">0</span>].address.add(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// safely modify bytes at address</span></span><br><span class="line">        Memory.patchCode(n_addr_assemble, <span class="number">4</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 以 thumb的方式获取一个patch对象</span></span><br><span class="line">            <span class="keyword">var</span> cw = <span class="keyword">new</span> ThumbWriter(n_addr_assemble);</span><br><span class="line">            <span class="comment">// 小端序</span></span><br><span class="line">            <span class="comment">// 00 20</span></span><br><span class="line">            cw.putInstruction(<span class="number">0x2000</span>)</span><br><span class="line">            <span class="comment">// 00 BF</span></span><br><span class="line">            cw.putInstruction(<span class="number">0xBF00</span>);</span><br><span class="line">            cw.flush(); <span class="comment">// 内存刷新</span></span><br><span class="line">            <span class="built_in">console</span>.log(hexdump(n_addr_assemble))</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(searchAndPatch);</span><br></pre></td></tr></table></figure>

<h4 id="Ⅱ-Unidbg-1"><a href="#Ⅱ-Unidbg-1" class="headerlink" title="Ⅱ Unidbg"></a>Ⅱ Unidbg</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SearchAndPatch</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] patterns = &#123;(<span class="keyword">byte</span>) <span class="number">0x80</span>, (<span class="keyword">byte</span>) <span class="number">0xb5</span>,<span class="number">0x6f</span>,<span class="number">0x46</span>, (<span class="keyword">byte</span>) <span class="number">0x84</span>, (<span class="keyword">byte</span>) <span class="number">0xb0</span>,<span class="number">0x03</span>, (<span class="keyword">byte</span>) <span class="number">0x90</span>,<span class="number">0x02</span>, (<span class="keyword">byte</span>) <span class="number">0x91</span>&#125;;</span><br><span class="line">    Collection&lt;Pointer&gt; pointers = searchMemory(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base+<span class="keyword">module</span>.size, patterns);</span><br><span class="line">    <span class="keyword">if</span>(pointers.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span> (Keystone keystone = <span class="keyword">new</span> Keystone(KeystoneArchitecture.Arm, KeystoneMode.ArmThumb)) &#123;</span><br><span class="line">            KeystoneEncoded encoded = keystone.assemble(<span class="string">&quot;movs r0,0;nop&quot;</span>);</span><br><span class="line">            <span class="keyword">byte</span>[] patchCode = encoded.getMachineCode();</span><br><span class="line">            ((ArrayList&lt;Pointer&gt;) pointers).get(<span class="number">0</span>).write(<span class="number">10</span>, patchCode, <span class="number">0</span>, patchCode.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Collection&lt;Pointer&gt; <span class="title">searchMemory</span><span class="params">(<span class="keyword">long</span> start, <span class="keyword">long</span> end, <span class="keyword">byte</span>[] data)</span> </span>&#123;</span><br><span class="line">    List&lt;Pointer&gt; pointers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> i = start, m = end - data.length; i &lt; m; i++) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] oneByte = emulator.getBackend().mem_read(i, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (data[<span class="number">0</span>] != oneByte[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Arrays.equals(data, emulator.getBackend().mem_read(i, data.length))) &#123;</span><br><span class="line">            pointers.add(UnidbgPointer.pointer(emulator, i));</span><br><span class="line">            i += (data.length - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pointers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>值得一提的是，本节的内容也可用 <a target="_blank" rel="noopener" href="https://github.com/lief-project/LIEF">LIEF</a> Patch二进制文件实现。</em></p>
<h2 id="七、Hook时机过晚问题"><a href="#七、Hook时机过晚问题" class="headerlink" title="七、Hook时机过晚问题"></a>七、Hook时机过晚问题</h2><p>上文中，Hook代码都位于 <strong>SO加载后， 执行JNI_OnLoad之前</strong>，和如下Frida代码Spawn注入进程等价。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> android_dlopen_ext = Module.findExportByName(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (android_dlopen_ext != <span class="literal">null</span>) &#123;</span><br><span class="line">    Interceptor.attach(android_dlopen_ext, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.hook = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">var</span> soName = args[<span class="number">0</span>].readCString();</span><br><span class="line">            <span class="keyword">if</span> (soName.indexOf(<span class="string">&quot;libhookinunidbg.so&quot;</span>) !== -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.hook = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.hook) &#123;</span><br><span class="line">                <span class="built_in">this</span>.hook = <span class="literal">false</span>;</span><br><span class="line">                <span class="comment">// your code</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而Unidbg Hook代码位于JNI_OnLoad后时，和如下Frida代码Spawn注入进程等价</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> android_dlopen_ext = Module.findExportByName(<span class="literal">null</span>, <span class="string">&quot;android_dlopen_ext&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (android_dlopen_ext != <span class="literal">null</span>) &#123;</span><br><span class="line">    Interceptor.attach(android_dlopen_ext, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.hook = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">var</span> soName = args[<span class="number">0</span>].readCString();</span><br><span class="line">            <span class="keyword">if</span> (soName.indexOf(<span class="string">&quot;libhookinunidbg.so&quot;</span>) !== -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.hook = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.hook) &#123;</span><br><span class="line">                <span class="built_in">this</span>.hook = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">var</span> jniOnload = Module.findExportByName(<span class="string">&quot;libhookinunidbg.so&quot;</span>,<span class="string">&quot;JNI_OnLoad&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span>(jniOnload != <span class="literal">null</span>)&#123;</span><br><span class="line">                    Interceptor.attach(jniOnload, &#123;</span><br><span class="line">                        <span class="attr">onEnter</span>:<span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">&quot;Enter libkwsgmain JNIOnLoad&quot;</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">onLeave</span>:<span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">&quot;After libkwsgmain JNIOnLoad&quot;</span>);</span><br><span class="line">                            <span class="comment">// your code</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>但如果**.init和.init_array段**存在代码逻辑（init→init_array→JNIOnLoad），我们想捕获这个时机，那么上述的时机点都太晚了，这种情况下就需要将Hook时机点提前到init执行前。在Frida中，为了实现这一点，通常做法是Hook Linker中的call_function或call_constructor函数。</p>
<p>以我们的demo hookInUnidbg为例，其中init段里就有如下逻辑，比较两个字符串的大小。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译生成后在.init段 [名字不可更改]</span></span><br><span class="line">extern <span class="string">&quot;C&quot;</span> <span class="function"><span class="keyword">void</span> <span class="title">_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> str1[<span class="number">15</span>];</span><br><span class="line">    <span class="keyword">char</span> str2[<span class="number">15</span>];</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    strcpy(str1, <span class="string">&quot;abcdef&quot;</span>);</span><br><span class="line">    strcpy(str2, <span class="string">&quot;ABCDEF&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ret = strcmp(str1, str2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LOGI(<span class="string">&quot;str1 小于 str2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(ret &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LOGI(<span class="string">&quot;str1 大于 str2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LOGI(<span class="string">&quot;str1 等于 str2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当前显示<strong>str1 大于 str2</strong>，我们的Hook目标是让其显示 <strong>str1 小于 str2</strong>。如果还想之前那样，在JNIOnLoad之前下断，是断不下来的，因为时机太晚了，Unidbg中可以使用下面几个办法。</p>
<h3 id="1-提前加载libc"><a href="#1-提前加载libc" class="headerlink" title="1.提前加载libc"></a>1.提前加载libc</h3><p>提前加载libc，然后hook strcmp函数，修改其返回值为-1是一个办法。如下是完整代码，提供了Console Debugger 以及 HookZz 两个版本。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tutorial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Emulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.context.RegisterContext;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.debugger.BreakPointCallback;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.hookzz.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"><span class="keyword">import</span> unicorn.ArmConst;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">hookInUnidbg</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module moduleLibc;</span><br><span class="line"></span><br><span class="line">    hookInUnidbg() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建模拟器实例</span></span><br><span class="line">        emulator = AndroidEmulatorBuilder.for32Bit().build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟器的内存操作接口</span></span><br><span class="line">        <span class="keyword">final</span> Memory memory = emulator.getMemory();</span><br><span class="line">        <span class="comment">// 设置系统类库解析</span></span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> AndroidResolver(<span class="number">23</span>));</span><br><span class="line">        <span class="comment">// 创建Android虚拟机</span></span><br><span class="line">        vm = emulator.createDalvikVM(<span class="keyword">new</span> File(<span class="string">&quot;unidbg-android/src/test/resources/tutorial/hookinunidbg.apk&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 先加载libc.so</span></span><br><span class="line">        DalvikModule dmLibc = vm.loadLibrary(<span class="keyword">new</span> File(<span class="string">&quot;unidbg-android/src/main/resources/android/sdk23/lib/libc.so&quot;</span>), <span class="keyword">true</span>);</span><br><span class="line">        moduleLibc = dmLibc.getModule();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// hook</span></span><br><span class="line">        hookStrcmpByUnicorn();</span><br><span class="line">        <span class="comment">// 或者</span></span><br><span class="line">        <span class="comment">// hookStrcmpByHookZz();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载so到虚拟内存</span></span><br><span class="line">        DalvikModule dm = vm.loadLibrary(<span class="string">&quot;hookinunidbg&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 加载好的 libhookinunidbg.so对应为一个模块</span></span><br><span class="line">        <span class="keyword">module</span> = dm.getModule();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行JNIOnLoad（如果有的话）</span></span><br><span class="line">        dm.callJNI_OnLoad(emulator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DvmClass dvmClass = vm.resolveClass(<span class="string">&quot;com/example/hookinunidbg/MainActivity&quot;</span>);</span><br><span class="line">        String methodSign = <span class="string">&quot;call()V&quot;</span>;</span><br><span class="line">        DvmObject&lt;?&gt; dvmObject = dvmClass.newObject(<span class="keyword">null</span>);</span><br><span class="line">        dvmObject.callJniMethodObject(emulator, methodSign);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        hookInUnidbg mydemo = <span class="keyword">new</span> hookInUnidbg();</span><br><span class="line">        mydemo.call();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hookStrcmpByUnicorn</span><span class="params">()</span></span>&#123;</span><br><span class="line">        emulator.attach().addBreakPoint(moduleLibc.findSymbolByName(<span class="string">&quot;strcmp&quot;</span>).getAddress(), <span class="keyword">new</span> BreakPointCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">long</span> address)</span> </span>&#123;</span><br><span class="line">                RegisterContext registerContext = emulator.getContext();</span><br><span class="line">                String arg1 = registerContext.getPointerArg(<span class="number">0</span>).getString(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                emulator.attach().addBreakPoint(registerContext.getLRPointer().peer, <span class="keyword">new</span> BreakPointCallback() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">long</span> address)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span>(arg1.equals(<span class="string">&quot;abcdef&quot;</span>))&#123;</span><br><span class="line">                            emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R0, -<span class="number">1</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hookStrcmpByHookZz</span><span class="params">()</span></span>&#123;</span><br><span class="line">        IHookZz hookZz = HookZz.getInstance(emulator); <span class="comment">// 加载HookZz，支持inline hook</span></span><br><span class="line">        hookZz.enable_arm_arm64_b_branch(); <span class="comment">// 测试enable_arm_arm64_b_branch，可有可无</span></span><br><span class="line">        hookZz.wrap(moduleLibc.findSymbolByName(<span class="string">&quot;strcmp&quot;</span>), <span class="keyword">new</span> WrapCallback&lt;HookZzArm32RegisterContext&gt;() &#123;</span><br><span class="line">            String arg1;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info)</span> </span>&#123;</span><br><span class="line">                arg1 = ctx.getPointerArg(<span class="number">0</span>).getString(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(arg1.equals(<span class="string">&quot;abcdef&quot;</span>))&#123;</span><br><span class="line">                    ctx.setR0(-<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        hookZz.disable_arm_arm64_b_branch();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但如果想hook的目标函数不是libc里的函数，就没效果了。比如想在0x978下个断点。</p>
<p><img src="https://cdn.jsdelivr.net/gh/404nofoundx/ImageCloud/9.png"></p>
<h3 id="2-固定地址下断点"><a href="#2-固定地址下断点" class="headerlink" title="2.固定地址下断点"></a>2.固定地址下断点</h3><p>这是最常用也最方便的方式，但只有Unicorn引擎下可以使用。</p>
<p>通过 <code>vm.loadLibrary</code> 加载的第一个用户SO，其基地址是0x40000000，因此可以在IDA中看函数偏移，通过绝对地址Console Debugger Hook。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tutorial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Emulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.context.RegisterContext;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.debugger.BreakPointCallback;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.hookzz.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"><span class="keyword">import</span> unicorn.ArmConst;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">hookInUnidbg</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line">    <span class="keyword">private</span> Module moduleLibc;</span><br><span class="line"></span><br><span class="line">    hookInUnidbg() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建模拟器实例</span></span><br><span class="line">        emulator = AndroidEmulatorBuilder.for32Bit().build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟器的内存操作接口</span></span><br><span class="line">        <span class="keyword">final</span> Memory memory = emulator.getMemory();</span><br><span class="line">        <span class="comment">// 设置系统类库解析</span></span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> AndroidResolver(<span class="number">23</span>));</span><br><span class="line">        <span class="comment">// 创建Android虚拟机</span></span><br><span class="line">        vm = emulator.createDalvikVM(<span class="keyword">new</span> File(<span class="string">&quot;unidbg-android/src/test/resources/tutorial/hookinunidbg.apk&quot;</span>));</span><br><span class="line"></span><br><span class="line">        emulator.attach().addBreakPoint(<span class="number">0x40000000</span> + <span class="number">0x978</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载so到虚拟内存</span></span><br><span class="line">        DalvikModule dm = vm.loadLibrary(<span class="string">&quot;hookinunidbg&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 加载好的 libhookinunidbg.so对应为一个模块</span></span><br><span class="line">        <span class="keyword">module</span> = dm.getModule();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行JNIOnLoad（如果有的话）</span></span><br><span class="line">        dm.callJNI_OnLoad(emulator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DvmClass dvmClass = vm.resolveClass(<span class="string">&quot;com/example/hookinunidbg/MainActivity&quot;</span>);</span><br><span class="line">        String methodSign = <span class="string">&quot;call()V&quot;</span>;</span><br><span class="line">        DvmObject&lt;?&gt; dvmObject = dvmClass.newObject(<span class="keyword">null</span>);</span><br><span class="line">        dvmObject.callJniMethodObject(emulator, methodSign);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        hookInUnidbg mydemo = <span class="keyword">new</span> hookInUnidbg();</span><br><span class="line">        mydemo.call();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/404nofoundx/ImageCloud/10.png"></p>
<p>如果加载了多个用户SO，可以先运行一遍代码，确认目标SO的基地址（Unidbg中不存在地址随机化，目标函数每次地址都固定。）然后在loadLibrary前Hook该地址，即可保证Hook不遗漏。</p>
<h3 id="3-使用Unidbg提供的模块监听器"><a href="#3-使用Unidbg提供的模块监听器" class="headerlink" title="3.使用Unidbg提供的模块监听器"></a>3.使用Unidbg提供的模块监听器</h3><p>实现自己的模块监听器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tutorial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Emulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.ModuleListener;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.context.RegisterContext;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.hookzz.HookEntryInfo;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.hookzz.HookZz;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.hook.hookzz.InstrumentCallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyModuleListener</span> <span class="keyword">implements</span> <span class="title">ModuleListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> HookZz hook;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoaded</span><span class="params">(Emulator&lt;?&gt; emulator, Module <span class="keyword">module</span>)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 提前加载Hook框架</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">module</span>.name.equals(<span class="string">&quot;libc.so&quot;</span>))&#123;</span><br><span class="line">             hook = HookZz.getInstance(emulator);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在目标函数中Hook</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">module</span>.name.equals(<span class="string">&quot;libhookinunidbg.so&quot;</span>))&#123;</span><br><span class="line">            hook.instrument(<span class="keyword">module</span>.base + <span class="number">0x978</span> + <span class="number">1</span>, <span class="keyword">new</span> InstrumentCallback&lt;RegisterContext&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dbiCall</span><span class="params">(Emulator&lt;?&gt; emulator, RegisterContext ctx, HookEntryInfo info)</span> </span>&#123;</span><br><span class="line">                    System.out.println(ctx.getIntArg(<span class="number">0</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>memory.addModuleListener</code>绑定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tutorial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">hookInUnidbg</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line"></span><br><span class="line">    hookInUnidbg() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建模拟器实例</span></span><br><span class="line">        emulator = AndroidEmulatorBuilder.for32Bit().build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟器的内存操作接口</span></span><br><span class="line">        <span class="keyword">final</span> Memory memory = emulator.getMemory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加模块加载监听器</span></span><br><span class="line">        memory.addModuleListener(<span class="keyword">new</span> MyModuleListener());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置系统类库解析</span></span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> AndroidResolver(<span class="number">23</span>));</span><br><span class="line">        <span class="comment">// 创建Android虚拟机</span></span><br><span class="line">        vm = emulator.createDalvikVM(<span class="keyword">new</span> File(<span class="string">&quot;unidbg-android/src/test/resources/tutorial/hookinunidbg.apk&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载so到虚拟内存</span></span><br><span class="line">        DalvikModule dm = vm.loadLibrary(<span class="string">&quot;hookinunidbg&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 加载好的 libhookinunidbg.so对应为一个模块</span></span><br><span class="line">        Module <span class="keyword">module</span> = dm.getModule();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行JNIOnLoad（如果有的话）</span></span><br><span class="line">        dm.callJNI_OnLoad(emulator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DvmClass dvmClass = vm.resolveClass(<span class="string">&quot;com/example/hookinunidbg/MainActivity&quot;</span>);</span><br><span class="line">        String methodSign = <span class="string">&quot;call()V&quot;</span>;</span><br><span class="line">        DvmObject&lt;?&gt; dvmObject = dvmClass.newObject(<span class="keyword">null</span>);</span><br><span class="line">        dvmObject.callJniMethodObject(emulator, methodSign);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        hookInUnidbg mydemo = <span class="keyword">new</span> hookInUnidbg();</span><br><span class="line">        mydemo.call();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>每种方法都有对应使用场景，按需使用。除此之外也可以修改Unidbg源码，在 callInitFunction函数前添加自己的逻辑。</em></p>
<h2 id="八、条件断点"><a href="#八、条件断点" class="headerlink" title="八、条件断点"></a>八、条件断点</h2><p>在算法分析时，条件断点可以减少干扰信息。以strcmp为例，整个进程的所有模块都可能调用strcmp函数。</p>
<h3 id="1-限定于某SO"><a href="#1-限定于某SO" class="headerlink" title="1.限定于某SO"></a>1.限定于某SO</h3><h4 id="ⅠFrida-4"><a href="#ⅠFrida-4" class="headerlink" title="ⅠFrida"></a>ⅠFrida</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Interceptor.attach(</span><br><span class="line">    Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;strcmp&quot;</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> moduleName = Process.getModuleByAddress(<span class="built_in">this</span>.returnAddress).name;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;strcmp arg1:&quot;</span>+args[<span class="number">0</span>].readCString())</span><br><span class="line">            <span class="comment">// 可以根据moduleName筛选打印</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;call from :&quot;</span>+moduleName)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span>(<span class="params">ret</span>) </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="Ⅱ-Unidbg-2"><a href="#Ⅱ-Unidbg-2" class="headerlink" title="Ⅱ Unidbg"></a>Ⅱ Unidbg</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hookstrcmp</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> address = <span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;strcmp&quot;</span>).getAddress();</span><br><span class="line">    emulator.attach().addBreakPoint(address, <span class="keyword">new</span> BreakPointCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">long</span> address)</span> </span>&#123;</span><br><span class="line">            RegisterContext registerContext = emulator.getContext();</span><br><span class="line">            String arg1 = registerContext.getPointerArg(<span class="number">0</span>).getString(<span class="number">0</span>);</span><br><span class="line">            String moduleName = emulator.getMemory().findModuleByAddress(registerContext.getLRPointer().peer).name;</span><br><span class="line">            <span class="keyword">if</span>(moduleName.equals(<span class="string">&quot;libhookinunidbg.so&quot;</span>))&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;strcmp arg1:&quot;</span>+arg1);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Unidbg中，“Hook限定于目标SO内”的使用场景可能不那么多，因为Unidbg虚拟进程里只有我们的目标SO在活跃，但Android系统中，目标进程里可能有数十个模块。当我们想hook strlen 来窥探目标SO里的字符串操作时，如果不加筛选，会被其他模块的大量调用干扰。或者我们想替换pthread_create函数，观察或者阻止子线程创建的时候，也会发现libart等模块也在创建子线程，除此之外替换时间等操作也都要注意这个问题。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 替换目标函数里对pthread_create的访问</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookPthreadCreate</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> p_pthread_create = Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> pthread_create = <span class="keyword">new</span> NativeFunction( p_pthread_create, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    Interceptor.replace( p_pthread_create, <span class="keyword">new</span> NativeCallback(<span class="function"><span class="keyword">function</span> (<span class="params">ptr0, ptr1, ptr2, ptr3</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> moduleName = Process.getModuleByAddress(<span class="built_in">this</span>.returnAddress).name;</span><br><span class="line">        <span class="keyword">if</span> (moduleName === <span class="string">&quot;target.so&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;loading fake pthread_create&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> pthread_create(ptr0,ptr1,ptr2,ptr3);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-限定于某函数"><a href="#2-限定于某函数" class="headerlink" title="2.限定于某函数"></a>2.限定于某函数</h3><p>比如某个函数在SO中被大量使用，现在只想分析这个函数在函数A中的使用。</p>
<h4 id="ⅠFrida-5"><a href="#ⅠFrida-5" class="headerlink" title="ⅠFrida"></a>ⅠFrida</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> show = <span class="literal">false</span>;</span><br><span class="line">Interceptor.attach(</span><br><span class="line">    Module.findExportByName(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;strcmp&quot;</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(show)&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;strcmp arg1:&quot;</span>+args[<span class="number">0</span>].readCString())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span>(<span class="params">ret</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">Interceptor.attach(</span><br><span class="line">    Module.findExportByName(<span class="string">&quot;libhookinunidbg.so&quot;</span>, <span class="string">&quot;targetfunction&quot;</span>),&#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">            show = <span class="built_in">this</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span>(<span class="params">ret</span>) </span>&#123;</span><br><span class="line">            show = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="Ⅱ-Unidbg-3"><a href="#Ⅱ-Unidbg-3" class="headerlink" title="Ⅱ Unidbg"></a>Ⅱ Unidbg</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 早先声明全局变量 public boolean show = false;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hookstrcmp</span><span class="params">()</span></span>&#123;</span><br><span class="line">    emulator.attach().addBreakPoint(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;targetfunction&quot;</span>).getAddress(), <span class="keyword">new</span> BreakPointCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">long</span> address)</span> </span>&#123;</span><br><span class="line">            RegisterContext registerContext = emulator.getContext();</span><br><span class="line"></span><br><span class="line">            show = <span class="keyword">true</span>;</span><br><span class="line">            emulator.attach().addBreakPoint(registerContext.getLRPointer().peer, <span class="keyword">new</span> BreakPointCallback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">long</span> address)</span> </span>&#123;</span><br><span class="line">                    show = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    emulator.attach().addBreakPoint(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;strcmp&quot;</span>).getAddress(), <span class="keyword">new</span> BreakPointCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">long</span> address)</span> </span>&#123;</span><br><span class="line">            RegisterContext registerContext = emulator.getContext();</span><br><span class="line">            String arg1 = registerContext.getPointerArg(<span class="number">0</span>).getString(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span>(show)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;strcmp arg1:&quot;</span>+arg1);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-限定于某处"><a href="#3-限定于某处" class="headerlink" title="3.限定于某处"></a>3.限定于某处</h3><p><img src="https://cdn.jsdelivr.net/gh/404nofoundx/ImageCloud/11.png"></p>
<p>比如上图，只关注0xA00 处发生的strcmp。一个办法是hook strcmp函数，只在lr寄存器=module.base + 0xA00 + 4 + 1时打印输出。</p>
<p>另一个办法是Console Debugger ,也很方便。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">emulator.attach().addBreakPoint(<span class="keyword">module</span>, <span class="number">0xA00</span>);</span><br><span class="line">emulator.attach().addBreakPoint(<span class="keyword">module</span>, <span class="number">0xA04</span>);</span><br></pre></td></tr></table></figure>

<p>一定要掌握这些知识，并做到灵活变通。在实际使用中，诸如“A hook生效后再打印B函数的输出“这样的需求是很常见的，否则每个函数都打印成百上千行会迷人眼，干扰对关键信息的寻找。</p>
<h2 id="九、系统调用拦截——以时间为例"><a href="#九、系统调用拦截——以时间为例" class="headerlink" title="九、系统调用拦截——以时间为例"></a>九、系统调用拦截——以时间为例</h2><p>这里说的系统调用拦截，并不是要对系统调用进行Hook，比如 <a target="_blank" rel="noopener" href="https://github.com/AeonLucid/frida-syscall-interceptor">frida - syscall - intercceptor</a> 这样，系统调用全部是Unidbg自己实现的，日志一开就能看，显然也没有Hook的必要。Unidbg的<strong>系统调用拦截</strong>是为了替换系统调用，修改Unidbg中系统调用的实现。</p>
<p>有两个问题需要解释</p>
<ul>
<li><p>为什么要修改系统调用？</p>
<p>Unidbg中部分系统调用没实现或者没实现好，以及有时候想要固定其输出，比如获取时间的系统调用，这些需求需要我们修复或修改Unidbg中系统调用的实现。</p>
</li>
<li><p>为什么不直接修改Unidbg源码</p>
<p>1是灵活性较差，2是我们的实现或修改并不是完美的，直接改Unidbg源码是对运行环境的污染，影响其他项目。</p>
</li>
</ul>
<p>在分析算法时，输入不变的前提下，如果输出在不停变化，会干扰算法分析，这种情况的一大来源是时间戳参与了运算。在Frida中，为了控制这种干扰因素，常常会Hook libc的gettimeodfay这个时间获取函数。</p>
<h3 id="1-Frida-3"><a href="#1-Frida-3" class="headerlink" title="1.Frida"></a>1.Frida</h3><p><em>hook time</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> time = Module.findExportByName(<span class="literal">null</span>, <span class="string">&quot;time&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (time != <span class="literal">null</span>) &#123;</span><br><span class="line">    Interceptor.attach(time, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// time返回秒级时间戳，修改返回值为100</span></span><br><span class="line">            retval.replace(<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>hook gettimeofday</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_gettimeofday</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> addr_gettimeofday = Module.findExportByName(<span class="literal">null</span>, <span class="string">&quot;gettimeofday&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> gettimeofday = <span class="keyword">new</span> NativeFunction(addr_gettimeofday, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]);</span><br><span class="line">    </span><br><span class="line">    Interceptor.replace(addr_gettimeofday, <span class="keyword">new</span> NativeCallback(<span class="function"><span class="keyword">function</span> (<span class="params">ptr_tz, ptr_tzp</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> result = gettimeofday(ptr_tz, ptr_tzp);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;hook gettimeofday:&quot;</span>, ptr_tz, ptr_tzp, result);</span><br><span class="line">            <span class="keyword">var</span> t = <span class="keyword">new</span> <span class="built_in">Int32Array</span>(<span class="built_in">ArrayBuffer</span>.wrap(ptr_tz, <span class="number">8</span>));</span><br><span class="line">            t[<span class="number">0</span>] = <span class="number">0xAAAA</span>;</span><br><span class="line">            t[<span class="number">1</span>] = <span class="number">0xBBBB</span>;</span><br><span class="line">            <span class="built_in">console</span>.log(hexdump(ptr_tz));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但Frida做这件事并不容易做圆满，单是libc.so，就有time、gettimeodfay、clock_gettime、clock 这四个库函数可以获取时间戳，而且样本可以通过内联汇编使用系统调用，获取时间戳。</p>
<h3 id="2-Unidbg-1"><a href="#2-Unidbg-1" class="headerlink" title="2.Unidbg"></a>2.Unidbg</h3><p>Unidbg中可以更方便、更大范围的固定时间，不必像Frida那般。time和gettimeodfay库函数基于gettimeodfay这个系统调用，clock_gettime和clock基于clock_gettime系统调用。所以只要在Unidbg中固定gettimeodfay和clock_gettime这两个系统调用获取的时间戳，就可以一劳永逸。</p>
<p>首先实现时间相关的系统调用处理器，其中的*System.currentTimeMillis()<em>和</em>System.nanoTime()*改成定数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tutorial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Emulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.ARM32SyscallHandler;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.SvcMemory;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.pointer.UnidbgPointer;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.unix.struct.TimeVal32;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.unix.struct.TimeZone;</span><br><span class="line"><span class="keyword">import</span> com.sun.jna.Pointer;</span><br><span class="line"><span class="keyword">import</span> unicorn.ArmConst;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Calendar;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeSyscallHandler</span> <span class="keyword">extends</span> <span class="title">ARM32SyscallHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TimeSyscallHandler</span><span class="params">(SvcMemory svcMemory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(svcMemory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">handleUnknownSyscall</span><span class="params">(Emulator emulator, <span class="keyword">int</span> NR)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (NR) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">78</span>:</span><br><span class="line">                <span class="comment">// gettimeofday</span></span><br><span class="line">                mygettimeofday(emulator);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">263</span>:</span><br><span class="line">                <span class="comment">// clock_gettime</span></span><br><span class="line">                myclock_gettime(emulator);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.handleUnknownSyscall(emulator, NR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mygettimeofday</span><span class="params">(Emulator&lt;?&gt; emulator)</span> </span>&#123;</span><br><span class="line">        Pointer tv = UnidbgPointer.register(emulator, ArmConst.UC_ARM_REG_R0);</span><br><span class="line">        Pointer tz = UnidbgPointer.register(emulator, ArmConst.UC_ARM_REG_R1);</span><br><span class="line">        emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R0, mygettimeofday(tv, tz));</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">mygettimeofday</span><span class="params">(Pointer tv, Pointer tz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> currentTimeMillis = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> tv_sec = currentTimeMillis / <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">long</span> tv_usec = (currentTimeMillis % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">        TimeVal32 timeVal = <span class="keyword">new</span> TimeVal32(tv);</span><br><span class="line">        timeVal.tv_sec = (<span class="keyword">int</span>) tv_sec;</span><br><span class="line">        timeVal.tv_usec = (<span class="keyword">int</span>) tv_usec;</span><br><span class="line">        timeVal.pack();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Calendar calendar = Calendar.getInstance();</span><br><span class="line">            <span class="keyword">int</span> tz_minuteswest = -(calendar.get(Calendar.ZONE_OFFSET) + calendar.get(Calendar.DST_OFFSET)) / (<span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">            TimeZone timeZone = <span class="keyword">new</span> TimeZone(tz);</span><br><span class="line">            timeZone.tz_minuteswest = tz_minuteswest;</span><br><span class="line">            timeZone.tz_dsttime = <span class="number">0</span>;</span><br><span class="line">            timeZone.pack();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CLOCK_REALTIME = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CLOCK_MONOTONIC = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CLOCK_THREAD_CPUTIME_ID = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CLOCK_MONOTONIC_RAW = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CLOCK_MONOTONIC_COARSE = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CLOCK_BOOTTIME = <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> nanoTime = System.nanoTime();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">myclock_gettime</span><span class="params">(Emulator&lt;?&gt; emulator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> clk_id = emulator.getBackend().reg_read(ArmConst.UC_ARM_REG_R0).intValue();</span><br><span class="line">        Pointer tp = UnidbgPointer.register(emulator, ArmConst.UC_ARM_REG_R1);</span><br><span class="line">        <span class="keyword">long</span> offset = clk_id == CLOCK_REALTIME ? System.currentTimeMillis() * <span class="number">1000000L</span> : System.nanoTime() - nanoTime;</span><br><span class="line">        <span class="keyword">long</span> tv_sec = offset / <span class="number">1000000000L</span>;</span><br><span class="line">        <span class="keyword">long</span> tv_nsec = offset % <span class="number">1000000000L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (clk_id) &#123;</span><br><span class="line">            <span class="keyword">case</span> CLOCK_REALTIME:</span><br><span class="line">            <span class="keyword">case</span> CLOCK_MONOTONIC:</span><br><span class="line">            <span class="keyword">case</span> CLOCK_MONOTONIC_RAW:</span><br><span class="line">            <span class="keyword">case</span> CLOCK_MONOTONIC_COARSE:</span><br><span class="line">            <span class="keyword">case</span> CLOCK_BOOTTIME:</span><br><span class="line">                tp.setInt(<span class="number">0</span>, (<span class="keyword">int</span>) tv_sec);</span><br><span class="line">                tp.setInt(<span class="number">4</span>, (<span class="keyword">int</span>) tv_nsec);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">case</span> CLOCK_THREAD_CPUTIME_ID:</span><br><span class="line">                tp.setInt(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                tp.setInt(<span class="number">4</span>, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;clk_id=&quot;</span> + clk_id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在自己的模拟器上使用它，原先模拟器创建是这么一句</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建模拟器实例</span></span><br><span class="line">emulator = AndroidEmulatorBuilder.for32Bit().build();</span><br></pre></td></tr></table></figure>

<p>修改如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建模拟器实例</span></span><br><span class="line">AndroidEmulatorBuilder builder = <span class="keyword">new</span> AndroidEmulatorBuilder(<span class="keyword">false</span>) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> AndroidEmulator <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AndroidARMEmulator(processName, rootDir,</span><br><span class="line">                backendFactories) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> UnixSyscallHandler&lt;AndroidFileIO&gt;</span></span><br><span class="line"><span class="function">            <span class="title">createSyscallHandler</span><span class="params">(SvcMemory svcMemory)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> TimeSyscallHandler(svcMemory);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">emulator = builder.build();</span><br></pre></td></tr></table></figure>

<h2 id="十、Hook-检测"><a href="#十、Hook-检测" class="headerlink" title="十、Hook 检测"></a>十、Hook 检测</h2><p>Anti Unidbg的方法浩如烟海，但事实上几乎没有主动Anti Unidbg的样本，有两方面原因</p>
<ul>
<li>Unidbg 自身的多个重大弱点没有解决，比如多线程和信号机制尚未实现。</li>
<li>Unidbg 普及率和推广度还不高。</li>
</ul>
<p>所以本节专注于Hook 检测。</p>
<h3 id="1-检测第三方Hook框架"><a href="#1-检测第三方Hook框架" class="headerlink" title="1.检测第三方Hook框架"></a>1.检测第三方Hook框架</h3><p>基于其Hook实现原理，可以对应检测。</p>
<h4 id="ⅠInline-Hook"><a href="#ⅠInline-Hook" class="headerlink" title="ⅠInline Hook"></a>ⅠInline Hook</h4><p>以我熟悉的inline Hook 检测为例，inline Hook 需要修改Hook处的前几个字节，跳转到自己的地方实现逻辑，最后再跳转回来。那么就有两类思路实现检测，首先开辟一个检测线程，对关键函数做如下二选一循环操作</p>
<ul>
<li>函数开头前几个字节是否被篡改</li>
<li>函数体是否完整未被修改，常使用crc32校验，为什么不用md5或其他哈希函数？因为crc32极快，性能影响小，碰撞率又在可接受的范围内</li>
</ul>
<p>相关项目：<a target="_blank" rel="noopener" href="https://github.com/liaogang/check_fish_inline_hook">check_fish_inline_hook</a></p>
<h4 id="Ⅱ-Got-Hook"><a href="#Ⅱ-Got-Hook" class="headerlink" title="Ⅱ Got Hook"></a>Ⅱ Got Hook</h4><p>相关项目：<a target="_blank" rel="noopener" href="https://github.com/SliverBullet5563/CheckGotHook">SliverBullet5563/CheckGotHook: 检测got hook（使用xhook测试）</a></p>
<h3 id="2-检测Unicorn-Based-Hook"><a href="#2-检测Unicorn-Based-Hook" class="headerlink" title="2.检测Unicorn Based Hook"></a>2.检测Unicorn Based Hook</h3><p>Unicorn Hook 似乎不可检测，但Unicorn也是可检测的。在星球的Anti-Unidbg系列，就提到过一种检测方式。在Android系统中，只支持对四字节对齐的内存地址做读写操作，所以通过内联汇编尝试向SP+1的位置做读写，在真机上会导致App崩溃，而Unidbg模拟执行不会出任何问题。当然，我们并不希望App崩溃，所以需要在代码中实现自己的信号处理函数，当此处发生异常时，信号处理函数接收信号并做出某种处理，因为Unidbg中程序不会异常，所以也不会走到信号处理函数，这里面可以设计形成差异。</p>
<p>除此之外，Unicorn下断点调试或者做指令追踪时，必然会导致函数运行时间超出常理，基于运行时间的反调试策略也可行。</p>
<h2 id="十一、Unidbg-Trace-五件套"><a href="#十一、Unidbg-Trace-五件套" class="headerlink" title="十一、Unidbg Trace 五件套"></a>十一、Unidbg Trace 五件套</h2><p>基于Frida 存在许多trace 方案，比如用于 trace JNI函数的 <a target="_blank" rel="noopener" href="https://github.com/chame1eon/jnitrace">JNItrace</a>，用于trace Java调用的 <a target="_blank" rel="noopener" href="https://github.com/hluwa/ZenTracer">ZenTrace</a>、<a target="_blank" rel="noopener" href="https://github.com/r0ysue/r0tracer">r0tracer</a>，又或者是官方的多功能 trace 工具 <a target="_blank" rel="noopener" href="https://frida.re/docs/frida-trace/">frida-trace</a>，用于指令级 trace 的 <a target="_blank" rel="noopener" href="https://frida.re/docs/stalker/">Frida Stalker</a>，又或者是trace SO中所有函数的 <a target="_blank" rel="noopener" href="https://github.com/Pr0214/trace_natives">trace_natives</a> ，以及Linux上著名的<a target="_blank" rel="noopener" href="https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/strace.html">strace</a> 或者 基于Frida 的 <a target="_blank" rel="noopener" href="https://github.com/AeonLucid/frida-syscall-interceptor">frida-syscall-interceptor</a>，用于 trace 系统调用。</p>
<p>在Unidbg 上，上述的大部分trace，只需要调整日志等级就能实现。我们这里所讲的trace，聚焦于如何让使用者对代码执行流有更强的掌控。</p>
<h3 id="1-Instruction-tracing"><a href="#1-Instruction-tracing" class="headerlink" title="1.Instruction tracing"></a>1.Instruction tracing</h3><p>令追踪包括两部分</p>
<ul>
<li>记录每条指令的执行，打印地址、机器码、汇编等信息</li>
<li>打印每条指令相关的寄存器值</li>
</ul>
<p>Unidbg 基于 Unicorn CodeHook 封装了指令追踪，方法和效果如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * trace instruction</span></span><br><span class="line"><span class="comment"> * note: low performance</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">TraceHook <span class="title">traceCode</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">TraceHook <span class="title">traceCode</span><span class="params">(<span class="keyword">long</span> begin, <span class="keyword">long</span> end)</span></span>;</span><br><span class="line"><span class="function">TraceHook <span class="title">traceCode</span><span class="params">(<span class="keyword">long</span> begin, <span class="keyword">long</span> end, TraceCodeListener listener)</span></span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/404nofoundx/ImageCloud/12.png"></p>
<p>Unidbg的指令追踪，在第一部分的工作做得很好，采用 模块名+相对偏移+机器码+绝对地址+汇编 的展示形式，但美中不足的是，它并没有做第二部分的工作，可以使用如下的脚本在Unidbg中实现完善的指令追踪，其原理也是实现了一个自己的codehook。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/zhkl0228/unidbg/pull/214/commits/64f9835ebc0d529b2b92cf2bb4846210dff20e3c">增加trace的部分 by dqzg12300 · Pull Request #214</a></p>
<h3 id="2-Function-Tracing"><a href="#2-Function-Tracing" class="headerlink" title="2.Function Tracing"></a>2.Function Tracing</h3><p>指令Trace是最细粒度的Trace，优点是细，缺点是动辄数百上千万行，让人迷失其中。函数粒度的trace则不然，粗糙但容易理解全貌，在算法还原的一些场景中会起到帮助。在IDA Debug中，即可选择函数追踪来记录函数调用，包括了有符号函数以及IDA识别并命名为Sub_addr的子函数。</p>
<p><img src="https://cdn.jsdelivr.net/gh/404nofoundx/ImageCloud/13.png"></p>
<p>在Frida上，可以使用 <a target="_blank" rel="noopener" href="https://github.com/Pr0214/trace_natives">trace_natives</a> 对 一个SO中的全部函数进行Trace，并形成如下调用图。</p>
<p><img src="https://cdn.jsdelivr.net/gh/404nofoundx/ImageCloud/14.png"></p>
<p>Unidbg中可以做到这一点吗？不妨看一下 Frida trace_natives 脚本，其中有三个关注点。</p>
<ul>
<li>如何获得一个SO的全部函数列表，就像IDA一样</li>
<li>如何Hook函数</li>
<li>如何获得调用层级关系，形成树结构</li>
</ul>
<p>关于问题1，trace_natives怎么解决的？直接编写IDA脚本获取IDA的函数列表 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFunctionList</span>():</span></span><br><span class="line">    functionlist = <span class="string">&quot;&quot;</span></span><br><span class="line">    minLength = <span class="number">10</span></span><br><span class="line">    maxAddress = ida_ida.inf_get_max_ea()</span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> idautils.Functions(<span class="number">0</span>, maxAddress):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">list</span>(idautils.FuncItems(func))) &gt; minLength:</span><br><span class="line">            functionName = <span class="built_in">str</span>(idaapi.ida_funcs.get_func_name(func))</span><br><span class="line">            oneFunction = <span class="built_in">hex</span>(func) + <span class="string">&quot;!&quot;</span> + functionName + <span class="string">&quot;\t\n&quot;</span></span><br><span class="line">            functionlist += oneFunction</span><br><span class="line">    <span class="keyword">return</span> functionlist</span><br></pre></td></tr></table></figure>

<p>脚本获取了函数以及对应函数名列表，同时通过minLength过滤较短的函数，至少包含10条汇编指令的函数才会被计入。这么做有两个原因</p>
<ul>
<li>过短的函数可能导致Frida Hook失败（inline hook 原理所致）</li>
<li>过短的函数可能是工具函数，调用次数多，但价值不大，让调用图变得臃肿不堪</li>
</ul>
<p>完整的IDA插件 getFunctions 代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ida_ida</span><br><span class="line"><span class="keyword">import</span> ida_nalt</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"><span class="keyword">from</span> idaapi <span class="keyword">import</span> plugin_t</span><br><span class="line"><span class="keyword">from</span> idaapi <span class="keyword">import</span> PLUGIN_PROC</span><br><span class="line"><span class="keyword">from</span> idaapi <span class="keyword">import</span> PLUGIN_OK</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFunctionList</span>():</span></span><br><span class="line">    functionlist = <span class="string">&quot;&quot;</span></span><br><span class="line">    minLength = <span class="number">10</span></span><br><span class="line">    maxAddress = ida_ida.inf_get_max_ea()</span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> idautils.Functions(<span class="number">0</span>, maxAddress):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="built_in">list</span>(idautils.FuncItems(func))) &gt; minLength:</span><br><span class="line">            functionName = <span class="built_in">str</span>(idaapi.ida_funcs.get_func_name(func))</span><br><span class="line">            oneFunction = <span class="built_in">hex</span>(func) + <span class="string">&quot;!&quot;</span> + functionName + <span class="string">&quot;\t\n&quot;</span></span><br><span class="line">            functionlist += oneFunction</span><br><span class="line">    <span class="keyword">return</span> functionlist</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取SO文件名和路径</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSoPathAndName</span>():</span></span><br><span class="line">    fullpath = ida_nalt.get_input_file_path()</span><br><span class="line">    filepath, filename = os.path.split(fullpath)</span><br><span class="line">    <span class="keyword">return</span> filepath, filename</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">getFunctions</span>(<span class="params">plugin_t</span>):</span></span><br><span class="line">    flags = PLUGIN_PROC</span><br><span class="line">    comment = <span class="string">&quot;getFunctions&quot;</span></span><br><span class="line">    <span class="built_in">help</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">    wanted_name = <span class="string">&quot;getFunctions&quot;</span></span><br><span class="line">    wanted_hotkey = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;getFunctions(v0.1) plugin has been loaded.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> PLUGIN_OK</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, arg</span>):</span></span><br><span class="line"></span><br><span class="line">        so_path, so_name = getSoPathAndName()</span><br><span class="line">        functionlist = getFunctionList()</span><br><span class="line">        script_name = so_name.split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>] + <span class="string">&quot;_functionlist_&quot;</span> + <span class="built_in">str</span>(<span class="built_in">int</span>(time.time())) + <span class="string">&quot;.txt&quot;</span></span><br><span class="line">        save_path = os.path.join(so_path, script_name)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(save_path, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> F:</span><br><span class="line">            F.write(functionlist)</span><br><span class="line">        F.close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;location: <span class="subst">&#123;save_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">term</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">PLUGIN_ENTRY</span>():</span></span><br><span class="line">    <span class="keyword">return</span> getFunctions()</span><br></pre></td></tr></table></figure>

<p>关于问题2：使用Frida Native Hook</p>
<p>关于问题3：Frida的frida-trace自带调用层级关系，所以trace_Natives脚本依赖Frida-trace，展示出了树结构的调用图。分析源码发现，frida-trace 使用了Frida在 Interceptor.attach 环境中的depth 如下代码中的this.depth），depth表示了调用深度。那深度的值哪来的呢？其最终依赖于Frida的栈回溯。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Interceptor.attach(Module.getExportByName(<span class="literal">null</span>, <span class="string">&#x27;read&#x27;</span>), &#123;</span><br><span class="line">  <span class="function"><span class="title">onEnter</span>(<span class="params">args</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Context information:&#x27;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Context  : &#x27;</span> + <span class="built_in">JSON</span>.stringify(<span class="built_in">this</span>.context));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Return   : &#x27;</span> + <span class="built_in">this</span>.returnAddress);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;ThreadId : &#x27;</span> + <span class="built_in">this</span>.threadId);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Depth    : &#x27;</span> + <span class="built_in">this</span>.depth);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Errornr  : &#x27;</span> + <span class="built_in">this</span>.err);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Save arguments for processing in onLeave.</span></span><br><span class="line">    <span class="built_in">this</span>.fd = args[<span class="number">0</span>].toInt32();</span><br><span class="line">    <span class="built_in">this</span>.buf = args[<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">this</span>.count = args[<span class="number">2</span>].toInt32();</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">onLeave</span>(<span class="params">result</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;----------&#x27;</span>)</span><br><span class="line">    <span class="comment">// Show argument 1 (buf), saved during onEnter.</span></span><br><span class="line">    <span class="keyword">const</span> numBytes = result.toInt32();</span><br><span class="line">    <span class="keyword">if</span> (numBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(hexdump(<span class="built_in">this</span>.buf, &#123; <span class="attr">length</span>: numBytes, <span class="attr">ansi</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Result   : &#x27;</span> + numBytes);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这三个问题能在Unidbg中解决吗？如果能解决，那就有了Unidbg 版的Function Tracing。</p>
<p>首先问题一，只是一个获取函数列表的插件，与使用Frida还是Unidbg无关，构不成问题。我们还可以更进一步思考，trace_Natives 依赖IDA实现对SO 函数的识别，但与此同时也增加了使用的复杂度，而且加壳的SO无法直接识别函数，必须得先dump+fix SO，其实还挺折腾人，不如不依赖IDA，换个办法识别函数。ARM中，函数序言常常以 push 指令开始，这可以代表绝大多数函数。配合Unidbg的BlockHook 或者 CodeHook，就可以解析并 Hook 这些函数，问题二也顺带解决了。少部分函数会遗漏，但也无关痛痒。BlockHook 还会提供当前基本块的大小，我们设置对较小的块不予理睬。</p>
<p>接下来就是问题三，栈回溯这块，Unidbg也实现了arm unwind栈回溯，一些情况下有Bug，但总体应该能用。但Unidbg没有提供打印深度的函数，在Unwinder类中添加一个它。</p>
<p><em>src/main/java/com/github/unidbg/unwind/Unwinder.java</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">depth</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    Frame frame = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span>((frame = unw_step(emulator, frame)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(frame.isFinish())&#123;</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来三步骤合一，组装代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">PrintStream traceStream = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 保存文件</span></span><br><span class="line">    String traceFile = <span class="string">&quot;unidbg-android/src/test/resources/app/traceFunctions.txt&quot;</span>;</span><br><span class="line">    traceStream = <span class="keyword">new</span> PrintStream(<span class="keyword">new</span> FileOutputStream(traceFile), <span class="keyword">true</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> PrintStream finalTraceStream = traceStream;</span><br><span class="line">emulator.getBackend().hook_add_new(<span class="keyword">new</span> BlockHook() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hookBlock</span><span class="params">(Backend backend, <span class="keyword">long</span> address, <span class="keyword">int</span> size, Object user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(size&gt;<span class="number">8</span>)&#123;</span><br><span class="line">            Capstone.CsInsn[] insns = emulator.disassemble(address, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span>(insns[<span class="number">0</span>].mnemonic.equals(<span class="string">&quot;push&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">int</span> level = emulator.getUnwinder().depth();</span><br><span class="line">                <span class="keyword">assert</span> finalTraceStream != <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; level ; i++)&#123;</span><br><span class="line">                    finalTraceStream.print(<span class="string">&quot;    |    &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                finalTraceStream.println(<span class="string">&quot;  &quot;</span>+<span class="string">&quot;sub_&quot;</span>+Integer.toHexString((<span class="keyword">int</span>) (address-<span class="keyword">module</span>.base))+<span class="string">&quot;  &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttach</span><span class="params">(Unicorn.UnHook unHook)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detach</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="keyword">module</span>.base, <span class="keyword">module</span>.base+<span class="keyword">module</span>.size, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>可以发现代码非常的简洁优雅，效果也不错</p>
<p><img src="https://cdn.jsdelivr.net/gh/404nofoundx/ImageCloud/15.png"></p>
<p>它还有三个明显的缺陷</p>
<p>1是时机过晚，init或者init_arrayz里的内容无法Hook到，可以结合第七节的方法进行完善。</p>
<p>2是有符号的函数也以sub_xxx 显示</p>
<p>3是导入表中的函数无法包括在内，因为原理上讲，只扫描so内push开头的函数。</p>
<h3 id="3-Memory-Search"><a href="#3-Memory-Search" class="headerlink" title="3.Memory Search"></a>3.Memory Search</h3><h3 id="4-Unidbg-FindKey"><a href="#4-Unidbg-FindKey" class="headerlink" title="4.Unidbg-FindKey"></a>4.Unidbg-FindKey</h3><p><a target="_blank" rel="noopener" href="https://github.com/Pr0214/Unidbg_FindKey">Unidbg_FindKey</a></p>
<p>这是我写的小工具，具体原理见星球，目前支持查找AES-128/AES-256的密钥，理论上还可以将更多的加密算法包括进去，只需要算法满足以下三点：</p>
<p>1.程序的预处理（最典型的场景即密钥编排）会产生某个结构</p>
<p>2.这个结构是可分辨的 </p>
<p>3.这个结构可以解码出原始Key </p>
<p>AES完美符合这三点，SM4也很适用，过往的研究表明，DES、RSA、TwoFish、Separnt等加密算法都满足或者部分满足上述三条件。</p>
<h3 id="5-Unidbg-Findcrypt"><a href="#5-Unidbg-Findcrypt" class="headerlink" title="5.Unidbg-Findcrypt"></a>5.Unidbg-Findcrypt</h3><p>Findcrypt是老牌经典工具，Unidbg版的Findcrypt是要做啥？解决什么痛点？有三个主要原因</p>
<ul>
<li>Findcrypt 处理不了加壳SO</li>
<li>Findcrypt 中说存在某种加密，但SO中并不一定用，我们的目标函数更不一定用。</li>
<li>从Findcrypt提示的常数不一定能找到对应函数，静态交叉分析有局限</li>
</ul>
<p>// TODO</p>
<h2 id="十二、固定随机数"><a href="#十二、固定随机数" class="headerlink" title="十二、固定随机数"></a>十二、固定随机数</h2><p>// TODO</p>
<h2 id="十三、杂项"><a href="#十三、杂项" class="headerlink" title="十三、杂项"></a>十三、杂项</h2><p>无需Hook，Unidbg中通过其他方式实现</p>
<p>// TODO</p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Unidbg/">Unidbg</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechat.png" alt="微信"></span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay.png" alt="支付宝"></span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>送我杯咖啡</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/20220110/Unidbg%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83%E4%B9%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Unidbg从入门到再入门之学习笔记</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/20220105/Tampermonkey%E6%B2%B9%E7%8C%B4%E8%84%9A%E6%9C%AC%E5%AE%89%E8%A3%85%E5%8F%8A%E5%85%A5%E9%97%A8/"><span class="level-item">Tampermonkey油猴脚本安装及入门</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="waline-thread"></div><script src="https://cdn.jsdelivr.net/npm/@waline/client@1.3.1/dist/Waline.min.js"></script><script>Waline({
            el: '#waline-thread',
            serverURL: "https://blog-api-ab4zca1le-404nofoundx.vercel.app/",
            lang: "zh-CN",
            visitor: false,
            emoji: ["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],
            dark: "auto",
            meta: ["nick","mail"],
            requiredMeta: [],
            login: "enable",
            avatar: "mp",
            
            pageSize: 10,
            avatarCDN: "https://sdn.geekzu.org/avatar/",
            avatarForce: false,
            highlight: true,
            mathTagSupport: false,
            copyright: true,
            locale: {"placeholder":"Comment here..."},
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.png" alt="Zhan"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Zhan</p><p class="is-size-6 is-block">爬虫工程师</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>BeiJing</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">38</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">10</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/404nofoundx" target="_blank" rel="noopener">关注我</a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#一、基础知识"><span class="level-left"><span class="level-item">一、基础知识</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-获取SO基地址"><span class="level-left"><span class="level-item">1.获取SO基地址</span></span></a></li><li><a class="level is-mobile" href="#2-获取函数地址"><span class="level-left"><span class="level-item">2.获取函数地址</span></span></a></li><li><a class="level is-mobile" href="#3-Unidbg-Hook-大盘点"><span class="level-left"><span class="level-item">3.Unidbg Hook 大盘点</span></span></a></li><li><a class="level is-mobile" href="#4-本篇的基础代码"><span class="level-left"><span class="level-item">4.本篇的基础代码</span></span></a></li></ul></li><li><a class="level is-mobile" href="#二、Hook-函数"><span class="level-left"><span class="level-item">二、Hook 函数</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-Frida"><span class="level-left"><span class="level-item">1.Frida</span></span></a></li><li><a class="level is-mobile" href="#2-Console-Debugger"><span class="level-left"><span class="level-item">2.Console Debugger</span></span></a></li><li><a class="level is-mobile" href="#3-第三方Hook框架"><span class="level-left"><span class="level-item">3.第三方Hook框架</span></span></a></li><li><a class="level is-mobile" href="#4-Unicorn-Hook"><span class="level-left"><span class="level-item">4.Unicorn Hook</span></span></a></li></ul></li><li><a class="level is-mobile" href="#三、Replace-参数和返回值"><span class="level-left"><span class="level-item">三、Replace 参数和返回值</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-替换参数"><span class="level-left"><span class="level-item">1.替换参数</span></span></a></li><li><a class="level is-mobile" href="#2-修改返回值"><span class="level-left"><span class="level-item">2.修改返回值</span></span></a></li></ul></li><li><a class="level is-mobile" href="#四、替换函数"><span class="level-left"><span class="level-item">四、替换函数</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-Frida-1"><span class="level-left"><span class="level-item">1.Frida</span></span></a></li><li><a class="level is-mobile" href="#2-第三方Hook框架"><span class="level-left"><span class="level-item">2.第三方Hook框架</span></span></a></li><li><a class="level is-mobile" href="#3-Console-Debugger"><span class="level-left"><span class="level-item">3.Console Debugger</span></span></a></li></ul></li><li><a class="level is-mobile" href="#五、Call-函数"><span class="level-left"><span class="level-item">五、Call 函数</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-Frida-2"><span class="level-left"><span class="level-item">1.Frida</span></span></a></li><li><a class="level is-mobile" href="#2-Unidbg"><span class="level-left"><span class="level-item">2.Unidbg</span></span></a></li></ul></li><li><a class="level is-mobile" href="#六、Patch-与内存检索"><span class="level-left"><span class="level-item">六、Patch 与内存检索</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-Patch"><span class="level-left"><span class="level-item">1.Patch</span></span></a></li><li><a class="level is-mobile" href="#2-内存检索"><span class="level-left"><span class="level-item">2.内存检索</span></span></a></li></ul></li><li><a class="level is-mobile" href="#七、Hook时机过晚问题"><span class="level-left"><span class="level-item">七、Hook时机过晚问题</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-提前加载libc"><span class="level-left"><span class="level-item">1.提前加载libc</span></span></a></li><li><a class="level is-mobile" href="#2-固定地址下断点"><span class="level-left"><span class="level-item">2.固定地址下断点</span></span></a></li><li><a class="level is-mobile" href="#3-使用Unidbg提供的模块监听器"><span class="level-left"><span class="level-item">3.使用Unidbg提供的模块监听器</span></span></a></li></ul></li><li><a class="level is-mobile" href="#八、条件断点"><span class="level-left"><span class="level-item">八、条件断点</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-限定于某SO"><span class="level-left"><span class="level-item">1.限定于某SO</span></span></a></li><li><a class="level is-mobile" href="#2-限定于某函数"><span class="level-left"><span class="level-item">2.限定于某函数</span></span></a></li><li><a class="level is-mobile" href="#3-限定于某处"><span class="level-left"><span class="level-item">3.限定于某处</span></span></a></li></ul></li><li><a class="level is-mobile" href="#九、系统调用拦截——以时间为例"><span class="level-left"><span class="level-item">九、系统调用拦截——以时间为例</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-Frida-3"><span class="level-left"><span class="level-item">1.Frida</span></span></a></li><li><a class="level is-mobile" href="#2-Unidbg-1"><span class="level-left"><span class="level-item">2.Unidbg</span></span></a></li></ul></li><li><a class="level is-mobile" href="#十、Hook-检测"><span class="level-left"><span class="level-item">十、Hook 检测</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-检测第三方Hook框架"><span class="level-left"><span class="level-item">1.检测第三方Hook框架</span></span></a></li><li><a class="level is-mobile" href="#2-检测Unicorn-Based-Hook"><span class="level-left"><span class="level-item">2.检测Unicorn Based Hook</span></span></a></li></ul></li><li><a class="level is-mobile" href="#十一、Unidbg-Trace-五件套"><span class="level-left"><span class="level-item">十一、Unidbg Trace 五件套</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-Instruction-tracing"><span class="level-left"><span class="level-item">1.Instruction tracing</span></span></a></li><li><a class="level is-mobile" href="#2-Function-Tracing"><span class="level-left"><span class="level-item">2.Function Tracing</span></span></a></li><li><a class="level is-mobile" href="#3-Memory-Search"><span class="level-left"><span class="level-item">3.Memory Search</span></span></a></li><li><a class="level is-mobile" href="#4-Unidbg-FindKey"><span class="level-left"><span class="level-item">4.Unidbg-FindKey</span></span></a></li><li><a class="level is-mobile" href="#5-Unidbg-Findcrypt"><span class="level-left"><span class="level-item">5.Unidbg-Findcrypt</span></span></a></li></ul></li><li><a class="level is-mobile" href="#十二、固定随机数"><span class="level-left"><span class="level-item">十二、固定随机数</span></span></a></li><li><a class="level is-mobile" href="#十三、杂项"><span class="level-left"><span class="level-item">十三、杂项</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">ZRocket</a><p class="is-size-7"><span>&copy; 2022</span>  Zhan  ♡  RR<br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客, <span id="busuanzi_value_site_pv">0</span>次访问</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://blog.csdn.net/qq_41179280?spm=1000.2115.3001.5343"><i class="fab fa-weibo"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://blog.csdn.net/qq_41179280?spm=1000.2115.3001.5343"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/404nofoundx"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script type="text/javascript" src="/js/love.js"></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>