<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><meta name="baidu-site-verification" content="code-Um7dmQVTiB"><title>Unidbg从入门到再入门之学习笔记 - R1024</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="R1024"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="R1024"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Unidbg从入门到再入门。"><meta property="og:type" content="blog"><meta property="og:title" content="R1024"><meta property="og:url" content="http://www.404nofoundx.top/20220110/Unidbg%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83%E4%B9%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><meta property="og:site_name" content="R1024"><meta property="og:description" content="Unidbg从入门到再入门。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://gitee.com/nofound404/image-cloud/raw/master/Unidbg_juzi.png"><meta property="article:published_time" content="2022-01-10T03:17:33.000Z"><meta property="article:modified_time" content="2022-05-05T04:31:19.042Z"><meta property="article:author" content="R1024"><meta property="article:tag" content="Unidbg"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://gitee.com/nofound404/image-cloud/raw/master/Unidbg_juzi.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.404nofoundx.top/20220110/Unidbg%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83%E4%B9%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"},"headline":"Unidbg从入门到再入门之学习笔记","image":["https://gitee.com/nofound404/image-cloud/raw/master/Unidbg_juzi.png"],"datePublished":"2022-01-10T03:17:33.000Z","dateModified":"2022-05-05T04:31:19.042Z","author":{"@type":"Person","name":"R1024"},"publisher":{"@type":"Organization","name":"R1024","logo":{"@type":"ImageObject","url":{"text":"R1024"}}},"description":"Unidbg从入门到再入门。"}</script><link rel="canonical" href="http://www.404nofoundx.top/20220110/Unidbg%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83%E4%B9%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?52c041fd9882a2d4b05bb16f933cdf75";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">R1024</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/404nofoundx"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><h1 class="title is-3 is-size-4-mobile">Unidbg从入门到再入门之学习笔记</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="far fa-calendar-alt"> </i><time dateTime="${date_xml(page.date)}" title="${date_xml(page.date)}">2022-01-10</time></span><span class="level-item is-hidden-mobile"><i class="far fa-calendar-check"> </i><time dateTime="${date_xml(page.updated)}" title="${date_xml(page.updated)}">2022-05-05</time></span><span class="level-item"><a class="link-muted" href="/categories/Unidbg/">Unidbg</a></span><span class="level-item">30 分钟读完 (大约4451个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><div class="content"><blockquote>
<p>部分内容来自：龙哥星球中Coffee的Unidbg学习笔记</p>
</blockquote>
<h1 id="一、初始化项目"><a href="#一、初始化项目" class="headerlink" title="一、初始化项目"></a>一、初始化项目</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建模拟器实例,进程名建议依照实际进程名填写，可以规避针对进程名的校验</span></span><br><span class="line">emulator = AndroidEmulatorBuilder.for32Bit().setProcessName(<span class="string">&quot;packename&quot;</span>).build();</span><br><span class="line"><span class="comment">// 获取模拟器的内存操作接口</span></span><br><span class="line">Memory memory = emulator.getMemory();</span><br><span class="line"><span class="comment">// 设置系统类库解析</span></span><br><span class="line">memory.setLibraryResolver(<span class="keyword">new</span> AndroidResolver(<span class="number">23</span>));</span><br><span class="line"><span class="comment">// 创建Android虚拟机,传入APK，Unidbg可以替我们做部分签名校验的工作</span></span><br><span class="line">vm = emulator.createDalvikVM(<span class="keyword">new</span> File(<span class="string">&quot;unidbg-android/src/test/java/com/l1/lvzhou.apk&quot;</span>));</span><br><span class="line"><span class="comment">// 加载so文件</span></span><br><span class="line">DalvikModule  dm = vm.loadLibrary(<span class="keyword">new</span> File(<span class="string">&quot;unidbg-android/src/test/java/com/l1/liboasiscore.so&quot;</span>),<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 获取So文件句柄</span></span><br><span class="line"><span class="keyword">module</span> = dm.getModule();</span><br><span class="line"><span class="comment">// 设置JNI</span></span><br><span class="line">vm.setJni(<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">// 打印日志</span></span><br><span class="line">vm.setVerbose(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 调用JNI Onloda</span></span><br><span class="line">dm.callJNI_OnLoad(emulator);</span><br></pre></td></tr></table></figure>

<h1 id="二、创建context类"><a href="#二、创建context类" class="headerlink" title="二、创建context类"></a>二、创建context类</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">DvmObject&lt;?&gt; context = vm.resolveClass(<span class="string">&quot;android/content/Context&quot;</span>).newObject(null);// context</span><br><span class="line"></span><br><span class="line">//或者</span><br><span class="line">DvmClass context = vm.resolveClass(<span class="string">&quot;android/content/Context&quot;</span>); </span><br><span class="line">DvmClass ContextWrapper = vm.resolveClass(<span class="string">&quot;android/content/ContextWrapper&quot;</span>, context); </span><br><span class="line">DvmClass Application = vm.resolveClass(<span class="string">&quot;android/app/Application&quot;</span>,ContextWrapper); </span><br><span class="line"><span class="built_in">return</span> Application.newObject(signature);</span><br><span class="line"></span><br><span class="line">//补环境的时候要注意</span><br><span class="line">@Override public DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">	switch (signature)&#123; </span><br><span class="line">	 <span class="keyword">case</span> <span class="string">&quot;android/app/ActivityThread- &gt;getApplication()Landroid/app/Application;&quot;</span>:&#123;</span><br><span class="line">		DvmClass context = vm.resolveClass(<span class="string">&quot;android/content/Context&quot;</span>); </span><br><span class="line">		DvmClass Application = vm.resolveClass(<span class="string">&quot;android/app/Application&quot;</span>,context); </span><br><span class="line">		<span class="built_in">return</span> Application.newObject(signature); </span><br><span class="line">		&#125;</span><br><span class="line">	 <span class="keyword">case</span> <span class="string">&quot;android/content/Context- &gt;getContentResolver()Landroid/content/ContentResolver;&quot;</span>:&#123;</span><br><span class="line">		<span class="built_in">return</span> vm.resolveClass(<span class="string">&quot;android/content/ContentResolver&quot;</span>).newObject(signature); </span><br><span class="line">		&#125; </span><br><span class="line">	 &#125;</span><br><span class="line">	<span class="built_in">return</span> super.callObjectMethodV(vm, dvmObject, signature, vaList); </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h1 id="三、字符串类型如何构造，字节数组如何构造，对象数组如何构造，参数2的实例对象怎么传？"><a href="#三、字符串类型如何构造，字节数组如何构造，对象数组如何构造，参数2的实例对象怎么传？" class="headerlink" title="三、字符串类型如何构造，字节数组如何构造，对象数组如何构造，参数2的实例对象怎么传？"></a>三、字符串类型如何构造，字节数组如何构造，对象数组如何构造，参数2的实例对象怎么传？</h1><p>传入Native的JAVA参数，除了八个基本类型外（byte、char、short、int、long、float、double、boolean），都必须vm.addLocalObject添加到局部引用中去。其他的对象类型一律要手动 addLocalObject。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//字符串</span></span><br><span class="line">list.add(vm.addLocalObject(<span class="keyword">new</span> StringObject(vm, <span class="string">&quot;12345&quot;</span>)));</span><br><span class="line">list.add(vm.addLocalObject(<span class="keyword">new</span> StringObject(vm, <span class="string">&quot;r0ysue&quot;</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">//字节数组</span></span><br><span class="line">ByteArray plainText = <span class="keyword">new</span> ByteArray(vm, <span class="string">&quot;r0ysue&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">list.add(vm.addLocalObject(plainText));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//参数2的实例对象怎么传</span></span><br><span class="line">需要注意的是，以往我一直直接把参数<span class="number">2</span>填<span class="number">0</span>，这是偷懒但有风险的做法，还是建议老老实实初始化类或对象，传hashCode进去，代码如下</span><br><span class="line"><span class="keyword">public</span> DvmClass cNative;</span><br><span class="line">cNative = vm.resolveClass(<span class="string">&quot;com/roysue/test623/MainActivity&quot;</span>);</span><br><span class="line">DvmObject&lt;?&gt; cnative = cNative.newObject(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">List&lt;Object&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">list.add(vm.getJNIEnv()); <span class="comment">// 第一个参数是env</span></span><br><span class="line">list.add(cnative.hashCode()); <span class="comment">// 第二个参数，实例方法是jobject，静态方法是jclazz，直接填0这里是不行的，此样本参数2被使用了</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h1 id="四、如何判断是Thumb还是ARM"><a href="#四、如何判断是Thumb还是ARM" class="headerlink" title="四、如何判断是Thumb还是ARM"></a>四、如何判断是Thumb还是ARM</h1><p>ARM模式指令总是4字节长度，Thumb指令长度多数为2字节，少部分指令是4字节。<br>1、找准一行汇编，Alt+G快捷键。Thumb模式是1，ARM模式是0。</p>
<p>代码是Thumb模式，调用的时候别忘了+1，Thumb的+1只在运行和Hook时需要考虑，打Patch和下断点不用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Number number = <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x1E7C</span> + <span class="number">1</span>, list.toArray())[<span class="number">0</span>];</span><br></pre></td></tr></table></figure>

<h1 id="五、patch修改指令"><a href="#五、patch修改指令" class="headerlink" title="五、patch修改指令"></a>五、patch修改指令</h1><p>第一种方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">patchVerify</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> patchCode = <span class="number">0x4FF00100</span>; <span class="comment">//mov r0,1  相对应的opcode就是4FF00100</span></span><br><span class="line">    emulator.getMemory().pointer(<span class="keyword">module</span>.base + <span class="number">0x1E86</span>).setInt(<span class="number">0</span>,patchCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二种方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">patchVerify</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> patchCode = <span class="number">0x4FF00100</span>;</span><br><span class="line">    emulator.getMemory().pointer(<span class="keyword">module</span>.base+<span class="number">0x1E86</span>).setInt(<span class="number">0</span>,patchCode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">patchVerify1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Pointer pointer = UnidbgPointer.pointer(emulator, <span class="keyword">module</span>.base + <span class="number">0x1E86</span>);</span><br><span class="line">    <span class="keyword">assert</span> pointer != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] code = pointer.getByteArray(<span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> (!Arrays.equals(code, <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123; (<span class="keyword">byte</span>)<span class="number">0xFF</span>, (<span class="keyword">byte</span>) <span class="number">0xF7</span>, (<span class="keyword">byte</span>) <span class="number">0xEB</span>, (<span class="keyword">byte</span>) <span class="number">0xFE</span> &#125;)) &#123; <span class="comment">// BL sub_1C60</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(Inspector.inspectString(code, <span class="string">&quot;patch32 code=&quot;</span> + Arrays.toString(code)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> (Keystone keystone = <span class="keyword">new</span> Keystone(KeystoneArchitecture.Arm, KeystoneMode.ArmThumb)) &#123;</span><br><span class="line">        KeystoneEncoded encoded = keystone.assemble(<span class="string">&quot;mov r0,1&quot;</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] patch = encoded.getMachineCode();</span><br><span class="line">        <span class="keyword">if</span> (patch.length != code.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(Inspector.inspectString(patch, <span class="string">&quot;patch32 length=&quot;</span> + patch.length));</span><br><span class="line">        &#125;</span><br><span class="line">        pointer.write(<span class="number">0</span>, patch, <span class="number">0</span>, patch.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="六、Unidbg-Hook使用"><a href="#六、Unidbg-Hook使用" class="headerlink" title="六、Unidbg Hook使用"></a>六、Unidbg Hook使用</h1><p><strong>hookZz</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HookMDStringOld</span><span class="params">()</span></span>&#123;</span><br><span class="line">    IHookZz hookZz = HookZz.getInstance(emulator);</span><br><span class="line">    hookZz.wrap(<span class="keyword">module</span>.base + <span class="number">0x1BD0</span> + <span class="number">1</span>, <span class="keyword">new</span> WrapCallback&lt;HookZzArm32RegisterContext&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="comment">// onEnter</span></span><br><span class="line">        <span class="comment">// 类似于 frida onEnter</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 类似于Frida args[0]</span></span><br><span class="line">            Pointer input = ctx.getPointerArg(<span class="number">0</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;input:&quot;</span> + input.getString(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="comment">// onLeave </span></span><br><span class="line">        <span class="comment">// 类似于 frida onLeave</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info)</span> </span>&#123;</span><br><span class="line">            Pointer result = ctx.getPointerArg(<span class="number">0</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;input:&quot;</span>+result.getString(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Inline hook</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hook_315B0</span><span class="params">()</span></span>&#123;</span><br><span class="line">        IHookZz hookZz = HookZz.getInstance(emulator);</span><br><span class="line">        hookZz.enable_arm_arm64_b_branch();</span><br><span class="line">        hookZz.instrument(<span class="keyword">module</span>.base + <span class="number">0x315B0</span> + <span class="number">1</span>, <span class="keyword">new</span> InstrumentCallback&lt;Arm32RegisterContext&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dbiCall</span><span class="params">(Emulator&lt;?&gt; emulator, Arm32RegisterContext ctx, HookEntryInfo info)</span> </span>&#123; <span class="comment">// 通过base+offset inline wrap内部函数，在IDA看到为sub_xxx那些</span></span><br><span class="line">                System.out.println(<span class="string">&quot;R2:&quot;</span>+ctx.getR2Long());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>Unidbg</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hookByUnicorn</span><span class="params">()</span></span>&#123;</span><br><span class="line">	emulator.getBackend().hook_add_new(<span class="keyword">new</span> CodeHook() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hook</span><span class="params">(Backend backend, <span class="keyword">long</span> address, <span class="keyword">int</span> size, Object user)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (address == <span class="keyword">module</span>.base + <span class="number">0x9D24</span>)&#123;</span><br><span class="line">				System.out.println(<span class="string">&quot;Hook By Unicorn&quot;</span>);</span><br><span class="line">				RegisterContext ctx = emulator.getContext();</span><br><span class="line">				Pointer input1 = ctx.getPointerArg(<span class="number">0</span>);</span><br><span class="line">				Pointer input2 = ctx.getPointerArg(<span class="number">1</span>);</span><br><span class="line">				Pointer input3 = ctx.getPointerArg(<span class="number">2</span>);</span><br><span class="line">				<span class="comment">// getString的参数i代表index,即input[i:]</span></span><br><span class="line">				System.out.println(<span class="string">&quot;参数1：&quot;</span>+input1.getString(<span class="number">0</span>));</span><br><span class="line">				System.out.println(<span class="string">&quot;参数2：&quot;</span>+input2.getString(<span class="number">0</span>));</span><br><span class="line">				System.out.println(<span class="string">&quot;参数3：&quot;</span>+input3.getString(<span class="number">0</span>));</span><br><span class="line">				buffer = ctx.getPointerArg(<span class="number">3</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(address == (<span class="keyword">module</span>.base + <span class="number">0x9d28</span>))&#123;</span><br><span class="line">				Inspector.inspect(buffer.getByteArray(<span class="number">0</span>,<span class="number">0x100</span>), <span class="string">&quot;Unicorn hook EncryptWallEncode&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttach</span><span class="params">(Unicorn.UnHook unHook)</span> </span>&#123;</span><br><span class="line">			System.out.println(<span class="string">&quot;onAttach&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detach</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			System.out.println(<span class="string">&quot;detach&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,<span class="keyword">module</span>.base + <span class="number">0x9D24</span>,<span class="keyword">module</span>.base + <span class="number">0x9D28</span>,<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="七、Unidbg-Console-Debugger"><a href="#七、Unidbg-Console-Debugger" class="headerlink" title="七、Unidbg Console Debugger"></a>七、Unidbg Console Debugger</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">HookByConsoleDebugger</span><span class="params">()</span></span>&#123;</span><br><span class="line">	Debugger debugger = emulator.attach();</span><br><span class="line">	debugger.addBreakPoint(<span class="keyword">module</span>.base+<span class="number">0x9d24</span>);</span><br><span class="line">	debugger.addBreakPoint(<span class="keyword">module</span>.base+<span class="number">0x9d28</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="八、loadLibrary"><a href="#八、loadLibrary" class="headerlink" title="八、loadLibrary"></a>八、loadLibrary</h1><p>如果在加载so到虚拟内存的步骤中，参数二设为false(即不执行init相关函数)，会出现乱码。其实其中的道理并不复杂，甚至可以说很简单——SO样本做了字符串的混淆或加密，以此来对抗分析人员，但字符串总是要解密的，不然怎么用呢？这个解密一般发生在Init array节或者JNI OnLoad中，又或者是该字符串使用前的任何一个时机。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DalvikModule dm = vm.loadLibrary(<span class="keyword">new</span> File(<span class="string">&quot;unidbg-android\\src\\test\\java\\com\\zuiyou\\libnet_crypto.so&quot;</span>), <span class="keyword">true</span>); <span class="comment">// 加载so到虚拟内存</span></span><br></pre></td></tr></table></figure>

<h1 id="九、各种补环境"><a href="#九、各种补环境" class="headerlink" title="九、各种补环境"></a>九、各种补环境</h1><p><strong>补Context</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; callStaticObjectMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;com/izuiyou/common/base/BaseApplication-&gt;getAppContext()Landroid/content/Context;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;android/content/Context&quot;</span>).newObject(<span class="keyword">null</span>);</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&quot;java/util/UUID-&gt;randomUUID()Ljava/util/UUID;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> dvmClass.newObject(UUID.randomUUID());</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.callStaticObjectMethodV(vm, dvmClass, signature, vaList);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>补一个空类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;android/content/Context-&gt;getClass()Ljava/lang/Class;&quot;</span>:&#123;</span><br><span class="line">            <span class="keyword">return</span> dvmObject.getObjectType();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>补具体类名</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">       <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;android/content/Context-&gt;getClass()Ljava/lang/Class;&quot;</span>:&#123;</span><br><span class="line">               <span class="keyword">return</span> dvmObject.getObjectType();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;java/lang/Class-&gt;getSimpleName()Ljava/lang/String;&quot;</span>:&#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> StringObject(vm, <span class="string">&quot;AppController&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>
<p><strong>补文件路径</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">       <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;android/content/Context-&gt;getClass()Ljava/lang/Class;&quot;</span>:&#123;</span><br><span class="line">               <span class="keyword">return</span> dvmObject.getObjectType();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;java/lang/Class-&gt;getSimpleName()Ljava/lang/String;&quot;</span>:&#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> StringObject(vm, <span class="string">&quot;AppController&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;android/content/Context-&gt;getFilesDir()Ljava/io/File;&quot;</span>:</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;java/lang/String-&gt;getAbsolutePath()Ljava/lang/String;&quot;</span>: &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> StringObject(vm, <span class="string">&quot;/data/user/0/cn.xiaochuankeji.tieba/files&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>
<p><strong>检测是否有调试</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">callStaticBooleanMethodV</span><span class="params">(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;android/os/Debug-&gt;isDebuggerConnected()Z&quot;</span>:&#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(signature);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><strong>使用Unidbg的API返回PID</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">callStaticIntMethodV</span><span class="params">(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">switch</span> (signature)&#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&quot;android/os/Process-&gt;myPid()I&quot;</span>:&#123;</span><br><span class="line">              <span class="keyword">return</span> emulator.getPid();</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(signature);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><strong>判断map是否为空</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">callBooleanMethod</span><span class="params">(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VarArg varArg)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="string">&quot;java/util/Map-&gt;isEmpty()Z&quot;</span>.equals(signature)) &#123;</span><br><span class="line">           TreeMap&lt;String, String&gt; treeMap = (TreeMap&lt;String, String&gt;)dvmObject.getValue();</span><br><span class="line">           <span class="keyword">return</span> treeMap.isEmpty();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">super</span>.callBooleanMethod(vm, dvmObject, signature, varArg);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><strong>补map.get</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethod(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VarArg varArg) 		&#123;</span><br><span class="line">       <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;java/util/Map-&gt;get(Ljava/lang/Object;)Ljava/lang/Object;&quot;</span>:</span><br><span class="line">               StringObject keyobject = varArg.getObjectArg(<span class="number">0</span>);</span><br><span class="line">               String key = keyobject.getValue();</span><br><span class="line">               TreeMap&lt;String, String&gt; treeMap = (TreeMap&lt;String, String&gt;)dvmObject.getValue();</span><br><span class="line">               String value = treeMap.get(key);</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> StringObject(vm, value);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">super</span>.callObjectMethod(vm, dvmObject, signature, varArg);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><strong>补SignedQuery类的init，也就是初始化一个SignedQuery对象</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; newObject(BaseVM vm, DvmClass dvmClass, String signature, VarArg varArg) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;com/bilibili/nativelibrary/SignedQuery-&gt;&lt;init&gt;(Ljava/lang/String;Ljava/lang/String;)V&quot;</span>:</span><br><span class="line">                StringObject stringObject1 = varArg.getObjectArg(<span class="number">0</span>);</span><br><span class="line">                StringObject stringObject2 = varArg.getObjectArg(<span class="number">1</span>);</span><br><span class="line">                String str1 = stringObject1.getValue();</span><br><span class="line">                String str2 = stringObject2.getValue();</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;com/bilibili/nativelibrary/SignedQuery&quot;</span>).newObject(<span class="keyword">new</span> SignedQuery(str1, str2));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.newObject(vm, dvmClass, signature, varArg);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; newObject(BaseVM vm, DvmClass dvmClass, String signature, VarArg varArg) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;com/bilibili/nativelibrary/SignedQuery-&gt;&lt;init&gt;(Ljava/lang/String;Ljava/lang/String;)V&quot;</span>:</span><br><span class="line">                StringObject stringObject1 = varArg.getObjectArg(<span class="number">0</span>);</span><br><span class="line">                StringObject stringObject2 = varArg.getObjectArg(<span class="number">1</span>);</span><br><span class="line">                String str1 = stringObject1.getValue();</span><br><span class="line">                String str2 = stringObject2.getValue();</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;com/bilibili/nativelibrary/SignedQuery&quot;</span>).newObject(<span class="keyword">new</span> SignedQuery(str1, str2));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.newObject(vm, dvmClass, signature, varArg);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//因为用jadx查看SignedQuery类的代码，有俩成员以及构造函数，所以根据他的成员和构造函数，newObject一个SignedQuery类，搞一个简化版的内部类给它用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SignedQuery</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> String a;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> String b;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SignedQuery</span><span class="params">(String str, String str2)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.a = str;</span><br><span class="line">            <span class="keyword">this</span>.b = str2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<p><strong>补签名</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">callIntMethod</span><span class="params">(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VarArg varArg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;android/content/pm/Signature-&gt;hashCode()I&quot;</span>:</span><br><span class="line">                <span class="keyword">if</span> (dvmObject <span class="keyword">instanceof</span> Signature) &#123;</span><br><span class="line">                    Signature sig = (Signature) dvmObject;</span><br><span class="line">                    <span class="keyword">return</span> sig.getHashCode();</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.callIntMethod(vm, dvmObject, signature, varArg);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>初始化异常类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> DvmObject&lt;?&gt; newObject(BaseVM vm, DvmClass dvmClass, String signature, VarArg varArg) &#123; </span><br><span class="line">	<span class="keyword">switch</span> (signature)&#123; </span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;java/lang/Throwable-&gt;&lt;init&gt;()V&quot;</span>:&#123; </span><br><span class="line">			<span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;java/lang/Throwable&quot;</span>).newObject(<span class="keyword">new</span> Throwable()); </span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">super</span>.newObject(vm, dvmClass, signature, varArg); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="十、文件重定向-文件访问"><a href="#十、文件重定向-文件访问" class="headerlink" title="十、文件重定向/文件访问"></a>十、文件重定向/文件访问</h1><p>当样本做文件访问时，Unidbg重定向到本机的某个位置，进入 src/main/java/com/github/unidbg/file/BaseFileSystem.java<br>在构造函数第三行加上 System.out.print(“virtual path:” + rootDir); 打印虚拟路径，接下来我们按照要求，在报错提示目录下新建对应文件夹，并把我们的apk复制进去，改名成报错提示需要的apk。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BaseFileSystem</span><span class="params">(Emulator&lt;T&gt; emulator, File rootDir)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.emulator = emulator;</span><br><span class="line">        <span class="keyword">this</span>.rootDir = rootDir;</span><br><span class="line">        System.out.print(<span class="string">&quot;virtual path:&quot;</span> + rootDir);</span><br></pre></td></tr></table></figure>

<p>创建模拟器实例的时候，加上setRootDir(new File(“target/rootfs”)，运行代码的时候会自动创建生成target/rootfs目录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emulator = AndroidEmulatorBuilder.for32Bit().setRootDir(<span class="keyword">new</span> File(<span class="string">&quot;target/rootfs&quot;</span>)).setProcessName(<span class="string">&quot;com.xunmeng.pinduoduo&quot;</span>).build();</span><br></pre></td></tr></table></figure>
<p>除此之外，也可以通过代码的方式进行操作</p>
<p>我们的类实现文件重定向的接口即可，只需要三个步骤，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1 实现IOResolve</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NBridge</span> <span class="keyword">extends</span> <span class="title">AbstractJni</span> <span class="keyword">implements</span> <span class="title">IOResolver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    NBridge()&#123;</span><br><span class="line">        emulator = AndroidEmulatorBuilder.for32Bit().setProcessName(<span class="string">&quot;com.meituan&quot;</span>).build();</span><br><span class="line">        <span class="keyword">final</span> Memory memory = emulator.getMemory(); <span class="comment">// 模拟器的内存操作接口</span></span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> AndroidResolver(<span class="number">23</span>)); <span class="comment">// 设置系统类库解析</span></span><br><span class="line"></span><br><span class="line">        vm = emulator.createDalvikVM(<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\pr0214\\Desktop\\DTA\\unidbg\\versions\\unidbg-2021-5-17\\unidbg-master\\unidbg-android\\src\\test\\java\\com\\lession7\\mt.apk&quot;</span>)); <span class="comment">// 创建Android虚拟机</span></span><br><span class="line">        <span class="comment">// 2 绑定IO重定向接口</span></span><br><span class="line">        emulator.getSyscallHandler().addIOResolver(<span class="keyword">this</span>);</span><br><span class="line">        vm.setVerbose(<span class="keyword">true</span>); <span class="comment">// 设置是否打印Jni调用细节</span></span><br><span class="line">        DalvikModule dm = vm.loadLibrary(<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\pr0214\\Desktop\\DTA\\unidbg\\versions\\unidbg-2021-5-17\\unidbg-master\\unidbg-android\\src\\test\\java\\com\\lession7\\libmtguard.so&quot;</span>), <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">module</span> = dm.getModule(); <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        vm.setJni(<span class="keyword">this</span>);</span><br><span class="line">        dm.callJNI_OnLoad(emulator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FileResult <span class="title">resolve</span><span class="params">(Emulator emulator, String pathname, <span class="keyword">int</span> oflags)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="string">&quot;/data/app/com.sankuai.meituan-TEfTAIBttUmUzuVbwRK1DQ==/base.apk&quot;</span>).equals(pathname)) &#123;</span><br><span class="line">            <span class="comment">// 填入想要重定位的文件</span></span><br><span class="line">            <span class="keyword">return</span> FileResult.success(<span class="keyword">new</span> SimpleFileIO(oflags, <span class="keyword">new</span> File(<span class="string">&quot;unidbg-android\\src\\test\\java\\com\\lession10\\mt.apk&quot;</span>), pathname));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>补文件</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> FileResult <span class="title">resolve</span><span class="params">(Emulator emulator, String pathname, <span class="keyword">int</span> oflags)</span> </span>&#123; </span><br><span class="line">		<span class="keyword">if</span> ((<span class="string">&quot;proc/&quot;</span>+emulator.getPid()+<span class="string">&quot;/cmdline&quot;</span>).equals(pathname)) &#123; </span><br><span class="line">			<span class="keyword">return</span> FileResult.success(<span class="keyword">new</span> ByteArrayFileIO(oflags, pathname, <span class="string">&quot;ctrip.android.view&quot;</span>.getBytes())); </span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>; </span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="comment">// 除此之外也可以像上面一样新建一个文件，传入文件</span></span><br><span class="line"><span class="keyword">return</span> FileResult.success(<span class="keyword">new</span> SimpleFileIO(oflags, <span class="keyword">new</span> File(<span class="string">&quot;D:\\unidbg-teach\\unidbg- android\\src\\test\\java\\com\\lession1\\cmdline&quot;</span>), pathname));</span><br></pre></td></tr></table></figure>

<h1 id="十一、打印地址所指向的内存，其效果类似于frida中hexdump，push保存，在后面再pop取出"><a href="#十一、打印地址所指向的内存，其效果类似于frida中hexdump，push保存，在后面再pop取出" class="headerlink" title="十一、打印地址所指向的内存，其效果类似于frida中hexdump，push保存，在后面再pop取出"></a>十一、打印地址所指向的内存，其效果类似于frida中hexdump，push保存，在后面再pop取出</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hook65540</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="comment">// 加载HookZz</span></span><br><span class="line">       IHookZz hookZz = HookZz.getInstance(emulator);</span><br><span class="line"></span><br><span class="line">       hookZz.wrap(<span class="keyword">module</span>.base + <span class="number">0x65540</span> + <span class="number">1</span>, <span class="keyword">new</span> WrapCallback&lt;HookZzArm32RegisterContext&gt;() &#123; <span class="comment">// inline wrap导出函数</span></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="comment">// 类似于 frida onEnter</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info)</span> </span>&#123;</span><br><span class="line">               <span class="comment">// 类似于Frida args[0]</span></span><br><span class="line">               Inspector.inspect(ctx.getR0Pointer().getByteArray(<span class="number">0</span>, <span class="number">0x10</span>), <span class="string">&quot;Arg1&quot;</span>);</span><br><span class="line">               System.out.println(ctx.getR1Long());</span><br><span class="line">               Inspector.inspect(ctx.getR2Pointer().getByteArray(<span class="number">0</span>, <span class="number">0x10</span>), <span class="string">&quot;Arg3&quot;</span>);</span><br><span class="line">			</span><br><span class="line">			ctx.push(ctx.getR2Pointer()); <span class="comment">//push保存</span></span><br><span class="line">           &#125;;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="comment">// 类似于 frida onLeave</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContext ctx, HookEntryInfo info)</span> </span>&#123;</span><br><span class="line">			<span class="comment">// pop 取出</span></span><br><span class="line">               Pointer output = ctx.pop();</span><br><span class="line">               Inspector.inspect(output.getByteArray(<span class="number">0</span>, <span class="number">0x10</span>), <span class="string">&quot;Arg3 after function&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h1 id="十二、如何主动调用一个Native函数"><a href="#十二、如何主动调用一个Native函数" class="headerlink" title="十二、如何主动调用一个Native函数"></a>十二、如何主动调用一个Native函数</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callMd5</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;Object&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// arg1</span></span><br><span class="line">        String input = <span class="string">&quot;r0ysue&quot;</span>;</span><br><span class="line">        <span class="comment">// malloc memory</span></span><br><span class="line">        MemoryBlock memoryBlock1 = emulator.getMemory().malloc(<span class="number">16</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// get memory pointer</span></span><br><span class="line">        UnidbgPointer input_ptr=memoryBlock1.getPointer();</span><br><span class="line">        <span class="comment">// write plainText on it</span></span><br><span class="line">        input_ptr.write(input.getBytes(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// arg2</span></span><br><span class="line">        <span class="keyword">int</span> input_length = input.length();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// arg3 -- buffer</span></span><br><span class="line">        MemoryBlock memoryBlock2 = emulator.getMemory().malloc(<span class="number">16</span>, <span class="keyword">false</span>);</span><br><span class="line">        UnidbgPointer output_buffer=memoryBlock2.getPointer();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 填入参入</span></span><br><span class="line">        list.add(input_ptr);</span><br><span class="line">        list.add(input_length);</span><br><span class="line">        list.add(output_buffer);</span><br><span class="line">        <span class="comment">// run</span></span><br><span class="line">        <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x65540</span> + <span class="number">1</span>, list.toArray());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// print arg3</span></span><br><span class="line">        Inspector.inspect(output_buffer.getByteArray(<span class="number">0</span>, <span class="number">0x10</span>), <span class="string">&quot;output&quot;</span>);</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<h1 id="十三、unidbg下断点"><a href="#十三、unidbg下断点" class="headerlink" title="十三、unidbg下断点"></a>十三、unidbg下断点</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">普通断点</span><br><span class="line">emulator.attach().addBreakPoint(<span class="keyword">module</span>.base + <span class="number">0x3161E</span>);</span><br><span class="line"></span><br><span class="line">内存写入断点</span><br><span class="line">emulator.traceWrite(<span class="keyword">module</span>.base + <span class="number">0x3A0C0</span>,<span class="keyword">module</span>.base + <span class="number">0x3A0C0</span>);</span><br></pre></td></tr></table></figure>
<p>命令</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">c: <span class="keyword">continue</span></span><br><span class="line">n: step over</span><br><span class="line">bt: back trace</span><br><span class="line"></span><br><span class="line">st hex: search stack</span><br><span class="line">shw hex: search writable heap</span><br><span class="line">shr hex: search readable heap</span><br><span class="line">shx hex: search executable heap</span><br><span class="line"></span><br><span class="line">nb: <span class="keyword">break</span> at next block</span><br><span class="line">s|si: step into</span><br><span class="line">s[decimal]: <span class="function">execute specified amount instruction</span></span><br><span class="line"><span class="function"><span class="title">s</span><span class="params">(blx)</span>: execute util BLX mnemonic, low performance</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">m</span><span class="params">(op)</span> [size]: show memory, <span class="keyword">default</span> size is 0x70, size may hex or decimal</span></span><br><span class="line"><span class="function">mr0-mr7, mfp, mip, msp [size]: show memory of specified register</span></span><br><span class="line"><span class="function"><span class="title">m</span><span class="params">(address)</span> [size]: show memory of specified address, address must start with 0x</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">wr0-wr7, wfp, wip, wsp : write specified register</span></span><br><span class="line"><span class="function"><span class="title">wb</span><span class="params">(address)</span>, <span class="title">ws</span><span class="params">(address)</span>, <span class="title">wi</span><span class="params">(address)</span> : <span class="title">write</span> <span class="params">(<span class="keyword">byte</span>, <span class="keyword">short</span>, integer)</span> memory of specified address, address must start with 0x</span></span><br><span class="line"><span class="function"><span class="title">wx</span><span class="params">(address)</span> : write bytes to memory at specified address, address must start with 0x</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">b</span><span class="params">(address)</span>: add temporarily breakpoint, address must start with 0x, can be <span class="keyword">module</span> offset</span></span><br><span class="line"><span class="function">b: add breakpoint of register PC</span></span><br><span class="line"><span class="function">r: remove breakpoint of register PC</span></span><br><span class="line"><span class="function">blr: add temporarily breakpoint of register LR</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">p</span> <span class="params">(assembly)</span>: patch assembly at PC address</span></span><br><span class="line"><span class="function">where: show java stack trace</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">trace [begin end]: Set trace instructions</span></span><br><span class="line"><span class="function">traceRead [begin end]: Set trace memory read</span></span><br><span class="line"><span class="function">traceWrite [begin end]: Set trace memory write</span></span><br><span class="line"><span class="function">vm: view loaded modules</span></span><br><span class="line"><span class="function">vbs: view breakpoints</span></span><br><span class="line"><span class="function">d|dis: show disassemble</span></span><br><span class="line"><span class="function"><span class="title">d</span><span class="params">(0x)</span>: show disassemble at specify address</span></span><br><span class="line"><span class="function">stop: stop emulation</span></span><br><span class="line"><span class="function">run [arg]: run test</span></span><br><span class="line"><span class="function">cc size: convert asm from 0x40001ddc - 0x40001ddc + size bytes to c function</span></span><br></pre></td></tr></table></figure>

<h1 id="十四、unidbg-traceCode"><a href="#十四、unidbg-traceCode" class="headerlink" title="十四、unidbg traceCode"></a>十四、unidbg traceCode</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">emulator.traceCode(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base + <span class="keyword">module</span>.size);</span><br><span class="line"></span><br><span class="line"><span class="comment">//traceCode保存到文件</span></span><br><span class="line">String traceFile = <span class="string">&quot;unidbg-android\\src\\test\\java\\com\\lession5\\qxstrace.txt&quot;</span>;</span><br><span class="line">PrintStream traceStream = <span class="keyword">new</span> PrintStream(<span class="keyword">new</span> FileOutputStream(traceFile), <span class="keyword">true</span>);</span><br><span class="line">emulator.traceCode(<span class="keyword">module</span>.base, <span class="keyword">module</span>.base+<span class="keyword">module</span>.size).setRedirect(traceStream);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//修改unidbg源码，保存关键的寄存器值信息</span></span><br><span class="line">找到代码文件 src/main/java/com/github/unidbg/arm/AbstractARMEmulator.java</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加值显示</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printAssemble</span><span class="params">(PrintStream out, Capstone.CsInsn[] insns, <span class="keyword">long</span> address, <span class="keyword">boolean</span> thumb)</span> </span>&#123;</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (Capstone.CsInsn ins : insns) &#123;</span><br><span class="line">        sb.append(<span class="string">&quot;### Trace Instruction &quot;</span>);</span><br><span class="line">        sb.append(ARM.assembleDetail(<span class="keyword">this</span>, ins, address, thumb));</span><br><span class="line">        <span class="comment">// 打印每条汇编指令里参与运算的寄存器的值</span></span><br><span class="line">        Set&lt;Integer&gt; regset = <span class="keyword">new</span> HashSet&lt;Integer&gt;();</span><br><span class="line"></span><br><span class="line">        Arm.OpInfo opInfo = (Arm.OpInfo) ins.operands;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;opInfo.op.length; i++)&#123;</span><br><span class="line">            regset.add(opInfo.op[i].value.reg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String RegChange = ARM.SaveRegs(<span class="keyword">this</span>, regset);</span><br><span class="line">        sb.append(RegChange);</span><br><span class="line">        sb.append(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        address += ins.size;</span><br><span class="line">    &#125;</span><br><span class="line">    out.print(sb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">src/main/java/com/github/unidbg/arm/ARM.java 中，新建SaveRegs方法，实际上就是showregs的代码，只不过从print改成<span class="keyword">return</span>回来而已。</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">SaveRegs</span><span class="params">(Emulator&lt;?&gt; emulator, Set&lt;Integer&gt; regs)</span> </span>&#123;</span><br><span class="line">        Backend backend = emulator.getBackend();</span><br><span class="line">        StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        builder.append(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>);</span><br><span class="line">        Iterator it = regs.iterator();</span><br><span class="line">        <span class="keyword">while</span>(it.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">int</span> reg = (<span class="keyword">int</span>) it.next();</span><br><span class="line">            Number number;</span><br><span class="line">            <span class="keyword">int</span> value;</span><br><span class="line">            <span class="keyword">switch</span> (reg) &#123;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_R0:</span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; r0=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_R1:</span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; r1=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_R2:</span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; r2=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_R3:</span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; r3=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_R4:</span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; r4=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_R5:</span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; r5=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_R6:</span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; r6=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_R7:</span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; r7=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_R8:</span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; r8=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_R9: <span class="comment">// UC_ARM_REG_SB</span></span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; sb=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_R10: <span class="comment">// UC_ARM_REG_SL</span></span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; sl=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_FP:</span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; fp=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_IP:</span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; ip=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_SP:</span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; SP=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_LR:</span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; LR=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ArmConst.UC_ARM_REG_PC:</span><br><span class="line">                    number = backend.reg_read(reg);</span><br><span class="line">                    value = number.intValue();</span><br><span class="line">                    builder.append(String.format(Locale.US, <span class="string">&quot; PC=0x%x&quot;</span>, value));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="十五、开启所有的日志"><a href="#十五、开启所有的日志" class="headerlink" title="十五、开启所有的日志"></a>十五、开启所有的日志</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.ARM32SyscallHandler&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.unix.UnixSyscallHandler&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.AbstractEmulator&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.android.dvm.DalvikVM&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.android.dvm.BaseVM&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.android.dvm&quot;</span>).setLevel(Level.DEBUG);</span><br></pre></td></tr></table></figure>
<h1 id="十六、注册libAndroid-so虚拟模块"><a href="#十六、注册libAndroid-so虚拟模块" class="headerlink" title="十六、注册libAndroid.so虚拟模块"></a>十六、注册libAndroid.so虚拟模块</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> AndroidModule(emulator,vm).register(memory);</span><br><span class="line"></span><br><span class="line">只用这一句即可，需要注意，一定要在样本SO加载前加载它(也就是vm.loadLibrary之前)。</span><br><span class="line">道理也很简单，系统SO肯定比用户SO加载早鸭。</span><br></pre></td></tr></table></figure>

<p><em><strong>Tips:</strong></em></p>
<p><strong>getPackageCodePath</strong></p>
<p>返回android 安装包的完整路径，这个包是一个zip的压缩文件，它包括应用程序的代码和assets文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 获取当前apk路径</span><br><span class="line">adb shell pm path apk包名</span><br></pre></td></tr></table></figure>


<p>方法：getFilesDir<br>释义：返回通过Context.openFileOutput()创建和存储的文件系统的绝对路径，应用程序文件，这些文件会在程序被卸载的时候全部删掉。</p>
<p>方法：getCacheDir<br>释义：返回应用程序指定的缓存目录，这些文件在设备内存不足时会优先被删除掉，所以存放在这里的文件是没有任何保障的，可能会随时丢掉。</p>
<p>方法：getDir<br>释义：这是一个可以存放你自己应用程序自定义的文件，你可以通过该方法返回的File实例来创建或者访问这个目录，注意该目录下的文件只有你自己的程序可以访问。</p>
<p>方法：getExternalCacheDir<br>释义：使用这个方法需要写外部存储的权限“<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />”，调用该方法会返回应用程序的外部文件系统（Environment.getExternalStorageDirectory()）目录的绝对路径，它是用来存放应用的缓存文件，它和getCacheDir目录一样，目录下的文件都会在程序被卸载的时候被清除掉。 </p>
<p>方法：getExternalFilesDir<br>释义：使用这个方法需要写外部存储的权限“<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />”，这个目录是与应用程序相关的外部文件系统，它和getExternalCacheDir不一样的是只要应用程序存在它就会一直存在，这些文件只属于你的应用，不能被其它人访问。同样，这个目录下的文件在程序被卸载时也会被一同删除。</p>
<p>方法：getDatabasePath<br>释义：保存通过Context.openOrCreateDatabase 创建的数据库文件</p>
<p>方法：getPackageCodePath<br>释义：返回android 安装包的完整路径，这个包是一个zip的压缩文件，它包括应用程序的代码和assets文件。</p>
<p>方法：getPackageResourcePath<br>释义：返回android 安装包的完整路径，这个包是一个ZIP的要锁文件，它包括应用程序的私有资源。</p>
<p>方法：getObbDir<br>释义：返回应用程序的OBB文件目录（如果有的话），注意如果该应用程序没有任何OBB文件，这个目录是不存在的。</p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Unidbg/">Unidbg</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered"> </h3><div class="buttons is-centered"><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信公众号</span><span class="qrcode"><img src="/img/qrcode.jpg" alt="微信公众号"></span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>知识星球</span><span class="qrcode"><img src="/img/zhishi_100.png" alt="知识星球"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/20220110/Frida%E4%B8%BB%E5%8A%A8%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Frida主动调用函数</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/20220106/Hook-All-In-Unidbg/"><span class="level-item">Hook All In Unidbg</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="waline-thread"></div><script src="https://cdn.jsdelivr.net/npm/@waline/client@1.3.1/dist/Waline.min.js"></script><script>Waline({
            el: '#waline-thread',
            serverURL: "https://blog-api-ab4zca1le-404nofoundx.vercel.app/",
            lang: "zh-CN",
            visitor: false,
            emoji: ["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],
            dark: "auto",
            meta: ["nick","mail"],
            requiredMeta: [],
            login: "enable",
            avatar: "mp",
            
            pageSize: 10,
            avatarCDN: "https://sdn.geekzu.org/avatar/",
            avatarForce: false,
            highlight: true,
            mathTagSupport: false,
            copyright: true,
            locale: {"placeholder":"Comment here..."},
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.png" alt="R1024"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">R1024</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">40</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">10</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/404nofoundx" target="_blank" rel="noopener">关注我</a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#一、初始化项目"><span class="level-left"><span class="level-item">一、初始化项目</span></span></a></li><li><a class="level is-mobile" href="#二、创建context类"><span class="level-left"><span class="level-item">二、创建context类</span></span></a></li><li><a class="level is-mobile" href="#三、字符串类型如何构造，字节数组如何构造，对象数组如何构造，参数2的实例对象怎么传？"><span class="level-left"><span class="level-item">三、字符串类型如何构造，字节数组如何构造，对象数组如何构造，参数2的实例对象怎么传？</span></span></a></li><li><a class="level is-mobile" href="#四、如何判断是Thumb还是ARM"><span class="level-left"><span class="level-item">四、如何判断是Thumb还是ARM</span></span></a></li><li><a class="level is-mobile" href="#五、patch修改指令"><span class="level-left"><span class="level-item">五、patch修改指令</span></span></a></li><li><a class="level is-mobile" href="#六、Unidbg-Hook使用"><span class="level-left"><span class="level-item">六、Unidbg Hook使用</span></span></a></li><li><a class="level is-mobile" href="#七、Unidbg-Console-Debugger"><span class="level-left"><span class="level-item">七、Unidbg Console Debugger</span></span></a></li><li><a class="level is-mobile" href="#八、loadLibrary"><span class="level-left"><span class="level-item">八、loadLibrary</span></span></a></li><li><a class="level is-mobile" href="#九、各种补环境"><span class="level-left"><span class="level-item">九、各种补环境</span></span></a></li><li><a class="level is-mobile" href="#十、文件重定向-文件访问"><span class="level-left"><span class="level-item">十、文件重定向/文件访问</span></span></a></li><li><a class="level is-mobile" href="#十一、打印地址所指向的内存，其效果类似于frida中hexdump，push保存，在后面再pop取出"><span class="level-left"><span class="level-item">十一、打印地址所指向的内存，其效果类似于frida中hexdump，push保存，在后面再pop取出</span></span></a></li><li><a class="level is-mobile" href="#十二、如何主动调用一个Native函数"><span class="level-left"><span class="level-item">十二、如何主动调用一个Native函数</span></span></a></li><li><a class="level is-mobile" href="#十三、unidbg下断点"><span class="level-left"><span class="level-item">十三、unidbg下断点</span></span></a></li><li><a class="level is-mobile" href="#十四、unidbg-traceCode"><span class="level-left"><span class="level-item">十四、unidbg traceCode</span></span></a></li><li><a class="level is-mobile" href="#十五、开启所有的日志"><span class="level-left"><span class="level-item">十五、开启所有的日志</span></span></a></li><li><a class="level is-mobile" href="#十六、注册libAndroid-so虚拟模块"><span class="level-left"><span class="level-item">十六、注册libAndroid.so虚拟模块</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">R1024</a><p class="is-size-7"><span>&copy; 2022</span>  Zhan  ♡  RR<br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客, <span id="busuanzi_value_site_pv">0</span>次访问</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://blog.csdn.net/qq_41179280?spm=1000.2115.3001.5343"><i class="fab fa-weibo"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://blog.csdn.net/qq_41179280?spm=1000.2115.3001.5343"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/404nofoundx"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script type="text/javascript" src="/js/love.js"></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>